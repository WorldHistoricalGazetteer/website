{% extends "main/base_webpack.html" %}
{% load static %}
{% load l10n %}

{% block extra_css %}
    #api-token-section.has-token #no-token {
      display: none;
    }
    #api-token-section:not(.has-token) #has-token {
      display: none;
    }
{% endblock %}

{% block content %}
<div id="container" class="container mt-1" xmlns="http://www.w3.org/1999/html">
  <div class="my-4">

    <h3 class="mb-4">
      <i class="fas fa-user-circle me-2"></i> Personal Data
    </h3>

    {% if needs_news_check %}
    <div class="alert alert-warning">
      Welcome, <b>{{ user.name }}</b>!
      Your account has been created via ORCiD.
    </div>
    {% endif %}

    <!-- ORCiD Data Section -->
    <section class="mb-4">
      <h5 class="mb-3 fw-semibold d-flex align-items-center">
        <i class="fab fa-orcid me-2" style="color:#A6CE39;"></i>
        ORCiD Data
        <a href="{% url 'accounts:profile-download' %}"
           data-bs-toggle="tooltip"
           data-bs-title="<i class='fas fa-download nocolour'></i> <strong>Download your personal data.</strong><br><br><i>This facility satisfies your <strong>right to access personal data</strong> in certain jurisdictions.</i>"
           class="btn btn-outline-secondary btn-sm ms-3">
          <i class="fa fa-download nocolour"></i> Download
        </a>
      </h5>
      <p class="small fst-italic text-muted mb-3">
        These details are maintained by ORCiD. If necessary, please edit them via your <a href="{{ ORCID_BASE }}/my-orcid" target="_blank" rel="noopener noreferrer">ORCiD profile</a>.
      </p>
      <div class="d-flex mb-2">
        <div class="flex-shrink-0 fw-semibold" style="max-width: 30%;">ORCiD iD</div>
        <div class="flex-grow-1 ps-3">
          <a href="{{ ORCID_BASE }}/{{ user.orcid }}" target="_blank" rel="noopener noreferrer">{{ ORCID_BASE }}/{{ user.orcid }}</a>
        </div>
      </div>
      <div class="d-flex mb-2">
        <div class="flex-shrink-0 fw-semibold" style="max-width: 30%;">Given Name</div>
        <div class="flex-grow-1 ps-3">{{ given_name_display|safe }}</div>
      </div>
      <div class="d-flex mb-2">
        <div class="flex-shrink-0 fw-semibold" style="max-width: 30%;">Family Name</div>
        <div class="flex-grow-1 ps-3">{{ surname_display|safe }}</div>
      </div>
      <div class="d-flex mb-2">
        <div class="flex-shrink-0 fw-semibold" style="max-width: 30%;">Email</div>
        <div class="flex-grow-1 ps-3">{{ email_display|safe }}</div>
      </div>
      <div class="d-flex mb-2">
        <div class="flex-shrink-0 fw-semibold" style="max-width: 30%;">Affiliation</div>
        <div class="flex-grow-1 ps-3">{{ affiliation_display|safe }}</div>
      </div>
      <div class="d-flex mb-2">
        <div class="flex-shrink-0 fw-semibold" style="max-width: 30%;">Web page</div>
          <div class="flex-grow-1 ps-3">
            {% if user.web_page %}
              <a href="{{ user.web_page }}" target="_blank" rel="noopener noreferrer">{{ user.web_page }}</a>
            {% else %}
              {{ web_page_display|safe }}
            {% endif %}
          </div>
      </div>
    </section>

{% if has_email %}
    <hr>

    <!-- Preferences Section -->
    <section>
      <h5 class="mb-3 fw-semibold"><i class="fas fa-cog me-2"></i> Preferences</h5>
      {% if needs_news_check %}
      <div class="alert alert-warning pulsing">
        Please consider signing up for our occasional news and updates.
        You can change your mind at any time by returning to this Profile page.
      </div>
      {% endif %}
      <form id="news-form" method="post" action="{% url 'profile-edit' %}">
        {% csrf_token %}
        <div class="form-check d-flex align-items-center mb-2">
          {{ form.news_permitted }}
          <label class="form-check-label ms-2 mb-0" for="{{ form.news_permitted.id_for_label }}" style="margin-bottom: -5px !important;">
            Receive News and Updates
          </label>
        </div>
      </form>
    </section>

    <hr>

    <!-- API Token Section -->
    <section>
      <h5 class="mb-3 fw-semibold d-flex align-items-baseline">
        <i class="fas fa-key me-2"></i>
        <span>API Token</span>
        <a target="_blank"
           href="https://docs.whgazetteer.org/content/400-Technical.html#api"
           class="ms-2 smaller fw-normal lh-1">
          see documentation <i class="fas fa-external-link-alt ms-1" aria-hidden="true"></i>
        </a>
      </h5>
      <div id="api-token-section" class="mb-2 {% if user.api_token %}has-token{% endif %}">
        <div id="has-token">
          <p>
            <strong>Your API Token:</strong>
            <code id="api-token" class="clippable openrefine">{{ api_token_key }}</code>
          </p>
          <p>
            <strong>Remaining Daily Quota:</strong>
            <span id="api-token-quota">{{ api_token_quota_remaining|localize }}</span> requests
            <i class="fas fa-info-circle text-muted smaller" data-bs-toggle="tooltip"
               data-bs-title="The API token allows you to make up to {{ api_token_quota }} requests per day. This quota resets at midnight UTC. Refresh this page to update the remaining quota."></i>
          </p>
          <button class="generate-token btn btn-outline-primary btn-sm me-2">
            <i class="fas fa-sync-alt me-1"></i> Regenerate Token
          </button>
          <button class="delete-token btn btn-outline-danger btn-sm">
            <i class="fas fa-trash me-1"></i> Delete Token
          </button>
        </div>
        <div id="no-token">
          <button class="generate-token btn btn-primary btn-sm">
            <i class="fas fa-plus me-1"></i> Generate API Token
          </button>
        </div>
      </div>
    </section>
{% else %}
    <hr>

    <!-- Limited Functionality Notice -->
    <section>
      <h5 class="mb-3 fw-semibold text-danger">
        <i class="fas fa-exclamation-triangle me-2"></i> Limited Account Functionality
      </h5>
      <div class="alert alert-info">
        <p class="mb-2">
          <strong>Your WHG account currently has very limited functionality</strong> because no email address is available from your ORCiD profile.
        </p>
        <p class="mb-2">
          Without an email address, the following features are unavailable:
        </p>
        <ul class="mb-3">
          <li>Receiving news and updates about WHG</li>
          <li>Contributing data to WHG</li>
          <li>Generating and using API tokens for programmatic access</li>
          <li>Receiving important notifications about your datasets and account</li>
        </ul>
        <p class="mb-0">
          <strong>Note:</strong> If you choose to add a verified email address to your <a href="{{ ORCID_BASE }}/my-orcid" target="_blank" rel="noopener noreferrer">ORCiD profile</a> and set its visibility to either "Trusted parties" or "Everyone", these features will become available the next time you log in to WHG. <em><b>THIS IS ENTIRELY OPTIONAL:</b> We respect your choice and control over your ORCiD data.</em>
        </p>
      </div>
    </section>
{% endif %}

    <hr>

    <!-- Account Deletion -->
    <section>
      <h5 class="mb-3 fw-semibold text-muted">
        <i class="fas fa-trash me-2"></i> Account Deletion
      </h5>

      <form method="post"
            action="{% url 'accounts:profile-delete' %}"
            onsubmit="if(confirm('Please confirm once more that you wish to delete your account. This action cannot be undone.')) { $('body').spin(); return true; } else { return false; }"
            class="d-inline-flex align-items-center gap-3">
        {% csrf_token %}

        <div class="form-check m-0">
          <input class="form-check-input" type="checkbox" id="confirmDelete" name="confirmDelete" required
              style="cursor:pointer;"
              data-bs-toggle="tooltip"
              data-bs-title="Checking this box confirms that you understand the consequences of deleting your account."
          >
          <label class="form-check-label mb-0" for="confirmDelete" style="cursor:pointer;">
            I understand that deleting my WHG account is <strong>permanent</strong> and cannot be undone.
          </label>
        </div>

        <button type="submit"
                class="btn btn-danger btn-sm align-self-center"
                style="line-height: normal;"
                data-bs-toggle="tooltip"
                data-bs-title="<i class='fas fa-triangle-exclamation'></i> This action is permanent and cannot be undone">
          <i class="fa fa-trash"></i> Delete Account
        </button>
      </form>
    </section>

  </div>
</div>

<script type="text/javascript">
  window.profileConfig = {
    apiTokenUrl: "{% url 'accounts:profile-api-token' %}",
    newsToggleUrl: "{% url 'accounts:profile-news-toggle' %}",
    csrfToken: "{{ csrf_token }}",
    domain: "{{ request.get_host }}",
  };
</script>
{% endblock %}

{% block deferredScripts %}

	var scripts = [
	{
	src: '{% static 'webpack/profile.bundle.js' %}',
	type: 'module',
	},
	]

{% endblock %}
