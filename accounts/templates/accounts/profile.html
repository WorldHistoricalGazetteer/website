{% extends "main/base_webpack.html" %}

{% block content %}
<div id="container" class="container mt-1">
  <div class="page-title-container mt-3">
    <h4 class="page-title">My Profile</h4>
    <a href="{% url 'dashboard' %}" class="header-link">
      {% if is_admin %}Admin {% else %}My {% endif %}Dashboard<i class="fas fa-columns ms-2"></i>
    </a>
  </div>

  <div class="row mt-4">
    <div class="col-md-2"></div>

    <!-- Left Column: ORCiD Data -->
    <div class="col-md-5">
      <div class="text-center mb-3">
        <div class="profile-placeholder">{{ user.name|first }}</div>
        <h5>{{ user.given_name }} {{ user.surname }}<small> ({{ user.username }})</small></h5>
      </div>

      {% if newly_created %}
      <div class="alert alert-success">
        Welcome, {{ user.get_full_name|default:user.username }}!
        Your account has been created via ORCiD.
      </div>
      {% endif %}

      <table class="table profile-table">
        <tr><td>Given name</td><td>{{ user.given_name }}</td></tr>
        <tr><td>Surname</td><td>{{ user.surname }}</td></tr>
        <tr><td>Email</td><td>{{ user.email }}</td></tr>
        <tr><td>Affiliation</td><td>{{ user.affiliation }}</td></tr>
        <tr><td>Web page</td><td><a href="{{ user.web_page }}" target="_blank" rel="noopener noreferrer">{{ user.web_page }}</a></td></tr>
        <tr><td>ORCiD iD</td><td><a href="https://orcid.org/{{ user.orcid }}" target="_blank" rel="noopener noreferrer">{{ user.orcid }}</a></td></tr>
        <tr><td>Newsletters</td><td>
          <form id="news-form" method="post" action="{% url 'profile-edit' %}">
            {% csrf_token %}
            <div class="form-check mb-3">
              {{ form.news_permitted }}
            </div>
          </form>
        </td></tr>
      </table>
      <a href="{% url 'accounts:profile-download' %}" class="btn btn-outline-secondary">
        Download my data
      </a>
    </div>

    <!-- Right Column: Options -->
    <div class="col-md-3 offset-md-1">

      <h6>Datasets Owned</h6>
      <div style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 0.5rem; margin-bottom: 1rem;">
        {% if datasets_owned %}
          <ul class="list-unstyled mb-0">
            {% for ds in datasets_owned %}
              <li>
                <a href="{% url 'datasets:detail' ds.0 %}">{{ ds.1 }}</a>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p><em>No datasets owned.</em></p>
        {% endif %}
      </div>

      <h6>Collections Owned</h6>
      <div style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 0.5rem;">
        {% if collections_owned %}
          <ul class="list-unstyled mb-0">
            {% for coll in collections_owned %}
              <li>
                <a href="{% url 'collections:detail' coll.0 %}">{{ coll.1 }}</a>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p><em>No collections owned.</em></p>
        {% endif %}
      </div>

      <div class="d-grid gap-2 mt-3">
        <form method="post" action="{% url 'accounts:profile-delete' %}" onsubmit="return confirm('Are you sure you want to delete your account? This action cannot be undone.')">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Delete my Account</button>
        </form>
      </div>
    </div>

  </div>
</div>

<script>
  // Auto-save news_permitted toggle on change (AJAX)
  document.addEventListener('DOMContentLoaded', function() {
    const newsCheckbox = document.getElementById('id_news_permitted');
    if(newsCheckbox){
      newsCheckbox.addEventListener('change', function() {
        const formData = new FormData();
        formData.append('news_permitted', newsCheckbox.checked ? 'on' : '');
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch("{% url 'accounts:profile-news-toggle' %}", {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: formData
        }).then(response => {
          if (!response.ok) {
            alert('Failed to save news preferences.');
          }
        }).catch(() => {
          alert('Failed to save news preferences.');
        });
      });
    }
  });
</script>
{% endblock %}
