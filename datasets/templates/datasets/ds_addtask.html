{% extends "main/base_webpack.html" %}
{% load static %}
{% load mathfilters %}
{% load dataset_extras %}

{% block maplibre %}
  <script type="text/javascript">
    const loadMaplibre = true;
  </script>
  <link href="{% static 'webpack/whg_maplibre.bundle.css' %}" rel="stylesheet"/>
{% endblock %}

{% block extra_head %}
  <link href="{% static 'webpack/tasks.bundle.css' %}" rel="stylesheet"/>
{% endblock %}

{% block title %}
  <title>Dataset::{{ ds.label }}</title>
{% endblock %}

{% block content %}
  <div id="dataset_content" class="container mt-1 px-1">
    <ul id="dataset_tabs" class="nav nav-tabs" role="tablist">
      <li class="nav-item">
          <a class="nav-link" id="summary-tab" data-link="summary" href="{% url 'datasets:ds_status' id=ds.id %}"
             role="tab" aria-controls="summary" aria-selected="false">Dataset Status</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="browse-tab" href="{% url 'datasets:ds_browse' id=ds.id %}" role="tab"
           aria-controls="browse" aria-selected="false">Browse</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="reconciliation-tab" href="{% url 'datasets:ds_reconcile' id=ds.id %}" role="tab"
           aria-controls="reconciliation" aria-selected="false">Reconciliation</a>
      </li>
      <li id="addtask_li" class="nav-item">
        <a class="nav-link active" id="addtask-tab" href="" role="tab" aria-controls="addtask" aria-selected="false">Add
          task</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="metadata-tab" href="{% url 'datasets:ds_metadata' id=ds.id %}" role="tab"
           aria-controls="metadata" aria-selected="false">Metadata</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="sharing-tab" href="{% url 'datasets:ds_collab' id=ds.id %}" role="tab"
           aria-controls="sharing" aria-selected="false">Collaborators</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="log-tab" data-bs-toggle="tab" href="#" role="tab" aria-controls="log"
           aria-selected="true">Log & Comments</a>
      </li>
    </ul>

    <div class="tab-content">
      <div id="addtask" class="tab-pane fade show active" role="tabpanel" aria-labelledby="addtask-tab">
        <h5 class="ms-0 me-3">Reconciliation for <span class="red-head">{{ ds.title }}</span></h5>
        <form action="{% url 'datasets:ds_recon' ds.id %}" method="POST">
          {% csrf_token %}
          <!-- only ds owner or superuser can run tasks -->
          {% if user.is_superuser or user in owners or user|has_group:'whg_team' %}
            <div class="row"> <!-- page-wide -->
              <div id="recon_form" class="col-md-7">
                <!-- if already indexed, running more tasks makes no sense -->
                {% if ds.unindexed == 0 and not user.is_superuser %}
                  <div>
                    <p class="mt-3 text-danger">This dataset is completely indexed. Further reconciliation not
                      permitted.</p>
                  </div>
                {% else %}
                  <input type="hidden" name="ds" value="{{ ds.id }}">
                  <input type="hidden" name="wd_lang" value="">

                  {% if ds.recon_status.idx %}
                    <p>Accessioning has begun for this dataset. Initiating another reconciliation task could disrupt
                      the workflow in progress. If you would like to stop the accessioning step and roll back the
                      workflow,
                      please <a href="#" class="feedback">contact the editorial team</a>.</p>
                  {% endif %}
                  <p class="font-weight-bold mb-0">Target index</p>
                  <div class="form-check">
                    <label class="form-check-label" for="r_wdlocal">
                      <input type="radio" class="form-check-input r_recon" id="r_wdlocal"
                             name="recon" value="wdlocal" {% if not ds.recon_status.idx %}checked{% else %}disabled{% endif %}>
                      Wikidata + GeoNames
                      <span class="ms-2 font-italic small">(estimated time: {{ numrows|time_estimate }})</span>
                    </label>
                    {% if msg_wdlocal %}
                      <div id="wdlocal_tasks" class="smaller">
                        <div class="mt-0 smaller radiodiv">
                          {{ msg_wdlocal.msg|safe }}
                          {% if msg_wdlocal.type == 'inprogress' %}
                            <label class="mb-0"><input type="radio" name="prior" value="keep" id="r_keep_wd">
                              keep prior match results</label>
                            <label class="mb-0"><input type="radio" name="prior" value="zap"> delete prior match results</label>
                          {% endif %}
                        </div>
                      </div>
                    {% endif %}
                  </div>

                  <div id="addtask_lower">
                    <hr/>
                    {% if not ds.recon_status.idx %}
                      <div class="row">
                        <div class="col-md-6">
                          <div class="recon-options">
                            <p class="allcap-heading small mb-0">TASK OPTIONS
                              <span class="help-matches" data-id="task_options">
                                  <i class="fas fa-question-circle linkypop"></i></span>
                            </p>
                            <div class="form-check small">
                              <input class="form-check-input" type="radio"
                                     name="scope_geom" id="geom_free" value="geom_free" checked>
                              <label class="form-check-label" for="geom_free">
                                Send only those records missing geometry</label>
                            </div>
                            <div class="form-check small">
                              <input class="form-check-input" type="radio"
                                     name="scope_geom" id="all" value="all">
                              <label class="form-check-label" for="all">
                                Send all records
                              </label>
                            </div>
                            <hr/>
                            <p class="small">
                              <input id="" name="no_geonames" type="checkbox"/> exclude GeoNames</p>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="recon-options">
                            <p class="allcap-heading small mb-0">REVIEW OPTIONS
                                <span class="help-matches" data-id="review_options">
                                    <i class="fas fa-question-circle linkypop"></i></span>
                            </p>
                            <p class="small">
                                <input id="aug_geom" name="accept_geom" type="checkbox" checked/>
                                  accept new geometry upon match
                            </p>
                            <p class="small">
                                <input id="aug_names" name="accept_names" type="checkbox" checked="checked"/>
                                  accept new name variants upon match
                            </p>
                            <p class="small">
                                <input id="aug_authids" name="accept_authids" type="checkbox" checked/>
                                  accept new authority IDs upon match
                            </p>
                          </div>
                        </div>
                      </div>
                    {% endif %}

                    {% comment %}
                    <div id="geo_constraint" class="mt-2">
                      <div class="mb-2">
                        <p class="font-weight-bold">Geographic bounds <span class="help-matches" data-id="geo_bounds"><i
                          class="fas fa-question-circle linkypop"></i></span>
                        </p>
                        <p>
                          <select id="select_region" name="region" class="custom-select-sm" style="width:auto;">
                            <option value="0">Select pre-defined region</option>
                            <option disabled>___________</option>
                            {% for r in region_list %}
                              <option value="{{ r.id }}">{{ r.title }}</option>
                            {% endfor %}
                          </select>
                          <span class="ms-2"><b>or...</b></span>
                        </p>
                        <p>
                          <select id="select_userarea" name="userarea" class="custom-select-sm" style="width:auto;">
                            <option value="0" selected="selected">Select user-defined study area</option>
                            <option disabled>___________</option>
                            {% for a in area_list %}
                              <option value="{{ a.id }}">{{ a.title }}</option>
                            {% endfor %}
                            <option value="create">{ new }</option>
                          </select>
                          <span class="ms-2 small">
                            <a href="{% url 'areas:area-create' %}?next=/datasets/{{ ds.id }}/addtask">create user area</a>
                          </span>
                        </p>
                      </div>
                    </div>
                    {% endcomment %}
                  </div>
                  {# buttons #}
                  <div class="bottom">
                    <hr/>
                    <p class="small">Your task will enter a queue and and an email notification sent when completed.</p>
                    <button type="submit" id="btn_startrecon" class="btn btn-primary">Start</button>
                    <span title="back"><a id="cancel_taskadd" href="#">Cancel</a></span>
                  </div>
                {% endif %} <!-- ds.unindexed -->
              </div> <!-- recon_form -->

              {# map column right #}
              <div id="recon_result" class="col-md-5 p-tight dashedbox">
                {% if request.method == 'GET' %}
                  <div id="mapdiv_recon" class="mt-2">
                    <span class="smallish">SEARCH BOUNDS: <span id="area_name" class="strong-red">Global</span></span>

                    <div id="map"></div>

                    <div id="geo_constraint" class="mt-1">
{#                      <hr/>#}
                      <div class="mb-2">
                        <p class="font-weight-bold">Geographic bounds <span class="help-matches" data-id="geo_bounds"><i
                          class="fas fa-question-circle linkypop"></i></span>
                        </p>
                        <p>
                          <select id="select_region" name="region" class="custom-select-sm" style="width:auto;">
                            <option value="0">Select pre-defined region</option>
                            <option disabled>___________</option>
                            {% for r in region_list %}
                              <option value="{{ r.id }}">{{ r.title }}</option>
                            {% endfor %}
                          </select>
                          <span class="ms-2"><b>or...</b></span>
                        </p>
                        <p>
                          <select id="select_userarea" name="userarea" class="custom-select-sm" style="width:auto;">
                            <option value="0" selected="selected">Select user-defined study area</option>
                            <option disabled>___________</option>
                            {% for a in area_list %}
                              <option value="{{ a.id }}">{{ a.title }}</option>
                            {% endfor %}
                            <option value="create">{ new }</option>
                          </select>
                          <span class="ms-2 small">
                            <a href="{% url 'areas:area-create' %}?next=/datasets/{{ ds.id }}/addtask">create user area</a>
                          </span>
                        </p>
                      </div>
                    </div>

                  </div>
                {% endif %}
                {% comment %}
                {% if not ds.recon_status.idx %}
                  <div>
                    <p class="allcap-heading small mb-0">OPTIONS</p>
                    <p><span id="q_accept" class="small">
                      <input id="accept_geom" name="geom" type="checkbox" checked="checked"/> accept geometries in matches
                      <span class="help-matches" data-id="accept-geometry"><i class="fas fa-question-circle linkypop"></i></span>
                    </span>
                    </p>
                  </div>
                {% endif %}
                {% endcomment %}

              </div> <!-- recon_result -->
            </div> <!-- row -->
          {% else %}
            <div>
              <p class="ps-3 text-danger"><b>Sorry, reconciliation tasks can only be initiated by dataset
              owners.</b></p>
            </div>
          {% endif %}
        </form>
        <div class="selector py-3">
          <div id="helpme"></div>
        </div>
      </div> <!-- .row -->
    </div> <!-- #addtask -->
  </div> <!-- .tab-content -->

  <div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel"
       aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="updateModalLabel">
            Update <span class="text-danger">{{ ds.label }}</span> dataset <small>(<i>{{ current_file.format }} file
            only</i>)</small>
          </h5>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <form id="newfileform" method="POST" action="#" enctype="multipart/form-data">
              {% csrf_token %}
              <div id="loadfile">
                <p><input type="file" id="newfile"></p>
                <button id="btn_upload" type="submit" class="btn btn-primary btn-sm hidden">Upload</button>
              </div>
              <div id="update_spinner"></div>
              <div id="results_text" class="mb-2 small ds-card">
                <p>Uploaded data will be compared with existing data, and results of that comparison reported here.</p>
                <p>You may then proceed, or cancel this operation with no changes made.</p>
              </div>
            </form>
          </div> <!-- .form-group -->
        </div> <!-- .modal-body -->
        <div class="modal-footer">
          <div id="buttons_pre">
            <button id="btn_cancel" type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Cancel</button>
            <button id="btn_update" type="button" data-dsid={{ ds.id }} class="btn btn-primary btn-sm hidden
            ">
            Proceed</button>
          </div>
          <button id="btn_done" type="button" class="btn btn-secondary btn-sm hidden" data-dismiss="modal">Done</button>
        </div>
      </div>
    </div>
  </div>
  </div>
{% endblock %}

{% block deferredScripts %}

  var scripts = [
  {
  src: '{% static 'webpack/whg_maplibre.bundle.js' %}',
  type: 'text/javascript',
  },
  {
  src: '{% static 'webpack/tasks.bundle.js' %}',
  type: 'module',
  },
  ]

{% endblock %}
