<!-- datasets/dataset_validate.html -->
{% extends "main/base_webpack.html" %}
{% block title %}<title>WHG::Validate Dataset</title>{% endblock %}

{% block content %}
{% load static %}
{% load dataset_extras %}

<style>
    .required-field {
        margin-bottom: 0;
    }
    .required-field::after {
        content: "*";
        color: red;
        font-size: xx-large;
        height: 20px;
        top: -12px;
        position: relative;
    }
    .input-group-prepend {
        align-items: center;
        display: flex;
    }
    .input-group-text .fas {
        color: #5d96cd;
        font-size: .8rem;
        vertical-align: super;
    }
    .dummy-file-input {
        border-top-right-radius: 0.375rem !important;
        border-bottom-right-radius: 0.375rem !important;
        cursor: pointer;
    }
    #id_file {
    	display: none;
    }
    form .alert {
        padding: 0 0.75rem !important;
    }
    form .alert p {
        margin: .5rem 0;
    }
    #validation_status {
    	display: none;
    }
    .progress {
        position: relative;
        height: 30px;
        background-color: white;
    }
    .progress-bar {
        background-color: #daebf1 !important;
        height: 100%;
        position: absolute;
    }
    .progress-bar-text {
        position: absolute;
        width: 100%;
        text-align: center;
        line-height: 30px;
        color: black;
        z-index: 2;
    }
</style>

<main class="container">
    <h4 class="mt-3">Validate Dataset</h4>
    <div id="content_validate" class="row mx-1">
        <div id="validate_form" class="form-box mt-2 col-md-7 col-lg-5">
            <form id="ds_validate_form" method="POST" enctype="multipart/form-data" novalidate class="needs-validation">
                {% csrf_token %}

                {% if form.errors %}
                <div class="alert alert-danger">
                    {% for field in form %}
                    {% for error in field.errors %}
                    <p>{{ error }}</p>
                    {% endfor %}
                    {% endfor %}
                </div>
                {% endif %}

                {% if messages %}
                <div class="alert alert-danger">
                    {% for message in messages %}
                    <p>{{ message|safe }}</p>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="mb-3 input-group">
                    <div class="input-group-prepend input-group-text">
                        Choose Data File
                        <a class="pointer" data-bs-toggle="popover" title="Data Formats" 
                          data-bs-content="There are specific requirements for your data file. Please read the note on Data Formats to the right of this form.">
                            <i class="fas fa-question-circle linky"></i>
                        </a>
                    </div>
                    <input type="text" id="file-name" class="form-control dummy-file-input" placeholder="(required)" required spellcheck="false">
                    {{ form.file }}
                </div>

                <div class="d-flex justify-content-end">
                    <a href="javascript:void(0);" onclick="window.history.back();" class="btn btn-secondary mx-2">Cancel</a>
                    <button type="submit" class="btn btn-primary">Validate</button>
                </div>

            </form>
            
            <div id="validation_status" class="mt-3">
			    <p id="file_name"></p>
			    <div class="progress">
				    <div id="progress_bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
				    <div id="progress_bar_text" class="progress-bar-text">0% Complete</div>
				</div>
			    <p id="estimated_time"></p>
			    <div id="fixes" class="collapse"></div>
			    <div id="errors" class="collapse"></div>
			</div>    
            
        </div>

        <div class="mt-2 col-md-5 col-lg-7" id="create_review">
            <div class="smallish">
                <p class="mb-0 text-uppercase"><b>data formats</b></p>
                <p class="mb-2">
                    The WHG platform can read two upload formats: 
                    <a href="https://github.com/LinkedPasts/linked-places" target="_blank">Linked Places</a> 
                    (JSON-LD based, GeoJSON compatible, expressive), and 
                    <a href="https://github.com/LinkedPasts/linked-places/blob/master/tsv_0.5.md" target="_blank">LP-TSV</a>, 
                    a tabular format for relatively simpler records uploaded as either text files (.csv, .tsv), or spreadsheets (.xlsx, .ods). 
                    <span class="strong"><i>NOTE: Encoding for all uploaded files must be unicode (UTF-8)</i>.</span>
                </p>
                <p class="mb-0 text-uppercase"><mark-g>Quick Start</mark-g></p>
                <ol class="mb-2 ps-3">
                    <li>Download a copy of 
                        <a href="https://docs.google.com/spreadsheets/d/1DM4MmagkYkeUEMtB00QZdYGkrCfth3_FsUp6JGGPwa0/copy" target="_blank">
                            this Google spreadsheet
                        </a> 
                        to your computer and follow its included instructions.
                    </li>
                    <li>Choose that file in the form on the left, fill out the first three fields of metadata, and click "Upload"&mdash;now you have a test dataset in your private workspace!</li>
                    <li>Explore WHG features for managing it from its new dataset page, e.g. under the Linking tab, begin reconciliation with our index of 13.5 million 
                        <a href="https://www.wikidata.org/" target="_blank">Wikidata</a> and 
                        <a href="https://www.geonames.org/" target="_blank">GeoNames</a> place records.
                    </li>
                </ol>
                <p class="mb-0 text-uppercase"><b>Sample data and templates</b></p>
                <p class="mb-2">Some sample datasets and templates are available in 
                    <a href="https://github.com/WorldHistoricalGazetteer/whgazetteer/raw/main/example_data/whg_example-data.zip" download>
                        this zip file
                    </a>, check its README.txt file, and try loading a sample from your local computer, then reconciling it against Wikidata records.
                </p>
                <p class="mb-0 text-uppercase"><b>Validation Errors</b></p>
                <p class="mb-2">Uploaded files are validated for conformance to our Linked Places format(s). In most cases, if there is a problem, an error message will explain, but the error-trapping is not yet perfect. If you are unable to upload a dataset successfully, please 
                    <a data-whg-modal="/contact_modal/">contact us</a>. We will gladly help sort out the issue quickly.
                </p>
                <p class="mb-0"><b>Consultation requests welcome!</b></p>
                <p class="mb-1">If you are planning a data contribution to WHG, or want help exploring its usefulness or feasibility for your project, please do 
                    <a data-whg-modal="/contact_modal/">contact us</a>.
                </p>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block inlineScripts %}
<script>
    $(document).ready(function() {
        $('.dummy-file-input')
            .on('keydown', function() {
                event.preventDefault();
            })
            .on('click', function() {
                $(this).next('input[type="file"]').click();
            });

        $('input[type="file"]').on('change', function() {
            var fileName = $(this).val().split('\\').pop();
            $(this).prev('.dummy-file-input').val(fileName);
        });

        $('#ds_validate_form').submit(function(event) {
            if (this.checkValidity() === false) {
                event.preventDefault();
                event.stopPropagation();
            } else {
                $('body').spin();
            }
            $(this).addClass('was-validated');
        });

        // Polling functionality for validation status
		function pollTaskStatus(taskId) {
		    const url = "{% url 'get_task_status' task_id='TASK_ID_PLACEHOLDER' %}".replace('TASK_ID_PLACEHOLDER', taskId);
		
		    $.get(url)
		        .done(function(data) {
		            if (data.status === "success") {
		                const taskStatus = data.task_status;
		
		                // Display file name and total features
		                $('#file_name').html(`Validating: <b>${taskStatus.original_file_name}</b>: <i>${taskStatus.total_features} features</i>`);
		                
		                if (!!taskStatus.remaining_queue) {
		                	bar_text = `Waiting ... Job #${taskStatus.remaining_queue+1} in queue.`;
		                }
		                else {
			                // Calculate and update progress
			                const totalFeatures = parseInt(taskStatus.total_features);
			                const processedFeatures = totalFeatures - parseInt(taskStatus.queued_features);
			                const progressPercent = (processedFeatures / totalFeatures) * 100;
			
			                $('#progress_bar')
			                    .css('width', `${progressPercent}%`)
			                    .attr('aria-valuenow', progressPercent);
			                
			                // Update estimated remaining time
			                const nonZeroRegex = /[1-9]/;
			                var remainingTime = '';
			                if (nonZeroRegex.test(taskStatus.estimated_remaining_time)) {
			                    const estimatedTimeParts = taskStatus.estimated_remaining_time.split(':');
			                    const minutes = estimatedTimeParts[1];
			                    const seconds = estimatedTimeParts[2].split('.')[0];
			                    remainingTime = `: ETA ${minutes}:${seconds}`;
			                }
		                	bar_text = `${progressPercent.toFixed(0)}%${remainingTime}`;
		                }
	
		                $('#progress_bar_text').text(bar_text);
		                
		
		                // Handle fixes (if any)
		                if (taskStatus.fixes && taskStatus.fixes.length > 0) {
		                    let fixesContent = `<p><a data-toggle="collapse" href="#fixes" role="button" aria-expanded="false" aria-controls="fixes">${taskStatus.fixes.length} Fixes (click to expand)</a></p><ul>`;
		                    taskStatus.fixes.forEach(fix => fixesContent += `<li>${fix}</li>`);
		                    fixesContent += `</ul>`;
		                    $('#fixes').html(fixesContent).collapse('hide');
		                } else {
		                    $('#fixes').html('');  // Clear if no fixes
		                }
		
		                // Handle errors (if any)
		                if (taskStatus.errors && taskStatus.errors.length > 0) {
		                    let errorsContent = `<p><a data-toggle="collapse" href="#errors" role="button" aria-expanded="false" aria-controls="errors">${taskStatus.errors.length} Errors (click to expand)</a></p><ul>`;
		                    taskStatus.errors.forEach(error => errorsContent += `<li>${error}</li>`);
		                    errorsContent += `</ul>`;
		                    $('#errors').html(errorsContent).collapse('hide');
		                } else {
		                    $('#errors').html('');  // Clear if no errors
		                }
		
		                // Handle different statuses
		                if (taskStatus.status === "complete") {
		                    console.log('Success - requires next step url.');
		                    // Optionally redirect or perform next steps here
		                } else if (taskStatus.status === "aborted") {
		                    $('#validation_status').html('<div class="alert alert-danger">Validation aborted: ' + (taskStatus.message || 'No additional details available.') + '</div>');
		                } else if (taskStatus.status === "in_progress") {
		                    // Continue polling if still in progress
		                    setTimeout(() => pollTaskStatus(taskId), 5000); // Poll every 5 seconds
		                }
		            } else {
		                $('#validation_status').html('<div class="alert alert-danger">Error: ' + data.message + '</div>');
		            }
		        })
		        .fail(function() {
		            $('#validation_status').html('<div class="alert alert-danger">An error occurred while checking the validation status.</div>');
		        });
		}

        // Start polling if task_id is available
        {% if task_id %}
        $('#ds_validate_form, #validation_status').toggle();
        pollTaskStatus("{{ task_id }}");
        {% endif %}
    });
</script>
{% endblock %}
