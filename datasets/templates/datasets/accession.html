<!-- datasets/accession.html -->
{% extends "main/base.html" %}
{% load leaflet_tags %}

{% load static %}
{% load dataset_extras %}
{% block title %}<title>Accessioning::{{ ds_label }}>{{authority}}</title>{% endblock %}
{% block extra_head %}
	<script src="{% static 'js/aliases.js' %}"></script>
	<link href="{% static 'webpack/maptiler_sdk.bundle.css' %}" rel="stylesheet" />
	<link href="{% static 'webpack/review.bundle.css' %}" rel="stylesheet" />
{% endblock %}
{% block content %}
<div class="container">
 		<h5 class="mb-2 mt-3">
  		{% if authority == 'idx' %}Accessioning{%else%}Reconciliation{%endif%} Review
	  	{% if deferred is True %}
	    	(<span class="text-danger">"deferred"</span>)
	  	{% endif %}
    	{% comment %}
	  		<span class="help" data-id="accessioning"><i class="fas fa-question-circle linkypop"></i></span>
	  	{% endcomment %}
	  	<span class="small ms-3"> <i>dataset</i>:
		  	<a href="{% url 'datasets:ds_reconcile' id=ds_id %}"> {{ ds_label }}</a>
	  	</span>
	  	<span class="half float-end me-2"><i>task id</i>: {{ task_id }}</span>
  	</h5>
  	{% if nohits %}
    	<div>
      		<p>No unreviewed hits for this accessioning task! {{ authority }}</p>
      		<p><a href="{% url 'datasets:ds_summary' id=ds_id %}">return to dataset summary page</a></p>
    	</div>
  	{% else %}
    	<form id="form_related" method="POST" action="" >
    		{% csrf_token %}
    		{{ formset.management_form }}
    		{% for record in records %}
    			<!-- there is only one; if last, do nothing -->
			    <div class="container">
			      	<div id="review_nav" class="row pagination justify-content-center">
			        	<div class="col-sm-4 ps-1">
				        	{% comment %} TODO: undo an accessioning match?
			            		<a id="undo" class="small hidden-imp" href="" data-url="{% url 'datasets:match-undo' ds=ds_id tid=task_id pid=999 %}">Undo last save {% fontawesome_icon 'undo' color='#336699' %}</a>
			           		{% endcomment %}
		        		</div>
			        	<div class="col-sm-8">
		          			<button type="submit" id="btn_save" class="button-sm me-2">Save</button>
		          			{% if deferred is False %}
		          				<a id="defer_link" rel="tooltip"
				            		title="flag for separate review" class="small"
				            		href="{% url 'places:defer-review' pid=record.id auth=authority last=records.paginator.num_pages  %}">defer
				            	</a>
				          	{% endif %}
		          			<span class="step-links">
		            			{% if records.has_previous %}
					                <a href="?page=1">&laquo; first</a>&nbsp;&nbsp;
					                <a href="?page={{ records.previous_page_number }}">previous</a>
		            			{% endif %}
		            			<span class="current">
		                			Record {{ records.number }} of {{ records.paginator.num_pages }}
		            			</span>
		            			{% if records.has_next %}
					                <a href="?page={{ records.next_page_number }}">next</a>&nbsp;&nbsp;
					                <a href="?page={{ records.paginator.num_pages }}">last &raquo;</a>
		            			{% endif %}
		          			</span>
			        		{% if test == 'on' %}
			          			<span class="bold float-end">VIEW ONLY</span>
			          		{% endif %}
		        		</div>
     					</div>
     					<div class="row mt-2">
				        <div id="review_record" class="col-sm-4 ps-0 small">
				          	<div class="bg-secondary font-weight-bold ps-2 text-light">{{ dataset_label }}</div>
				          	<div id="place_record" class="mb-2">
					            <div>
					              	<input type="hidden" name="place_id" value="{{ record.id }}" />
					              	<span>
					                	<h4 class="text-danger">{{ record.title }}
					                  		{% if record.geoms %}
						                  		<span class="ms-2">
						                  			<svg height="18" width="18">
						                    			<circle cx="9" cy="8" r="7" stroke="grey" stroke-width="1" fill="green" fill-opacity="0.4"/>
	                  								</svg>
	                  							</span>
                  							{% endif %}
						                  	<span class="float-end">
						                    	<button type="button" data-id="{{ record.id }}" class="create-comment btn"
						                      		data-src='record'> <i class="fas fa-edit linky fa-xs"></i>
						                      	</button>
						                  	</span>
						                </h4>
						        	</span>
								</div>
					        	{% for g in record.geoms.all %}
					              	{{ g.jsonb|safe|json_script:record.id }}
					            {% endfor %}
					            <p><strong>WHG place id</strong>: {{ record.id }} </p>
					            <p><strong>Source id</strong>: {{ record.src_id }}</p>
					            <p class="scroll100"><strong>Name variants</strong>:<i>
					              	{% for name in record.names.all %}
					               		{{ name.jsonb.toponym }};
					              	{% endfor %}</i>
					            </p>
					            {% if countries %}
					            	<p>
					            		<strong>Modern countries</strong>:
					              		{% for c in countries %}
					                	{{ c }};
					              		{% endfor %}
					              	</p>
					            {% endif %}
					            {% if record.related.all|length > 0 %}
					            	<p>
					            		<strong>Relations</strong>:
						              	{% for rel in record.related.all %}
						                	{{ rel.jsonb.label }}; <!--({ rel.jsonb.relationType }); -->
						              	{% endfor %}
						        	</p>
					            {% endif %}
					            <p>
					            	<strong>Place type(s)</strong>:
					              	{% for type in record.types.all %}
					                	{{ type.jsonb.sourceLabel }} ({{ type.jsonb.label }});
					              	{% endfor %}
					            </p>
					            {% if record.links.all|length > 0 %}
					            	<p>
					            		<strong>Links</strong>:
					              		{% for link in record.links.all %}
					                		<a href="" class="me-2 ext" data-toggle="modal" data-target="#ext_site">{{ link.jsonb.identifier }} <i class="fas fa-external-link-alt linky"></i></a>
					              		{% endfor %}
					              	</p>
					            {% endif %}
				            	{% if record.minmax %}
				              		{% if record.minmax.0 == record.minmax.1 %}
				              			<p><strong>Attested year</strong>: {{record.minmax.0}}</p>
				              		{% else %}
				              			<p><strong>Eariest/latest:</strong>: {{record.minmax.0}} / {{record.minmax.1}}</p>
				              		{% endif %}
				            	{% endif %}
				            	{% if record.descriptions %}
				              		{% for d in record.descriptions.all %}
				              			<p><strong>Description</strong>: {{d.jsonb.value}}</p>
				              		{%endfor%}
				            	{% endif %}
				     		</div> <!-- place_record -->
			          		<div id="map" style="height:300px;"></div>
       					</div>
				        <!--available: ['whg_id', 'place_id', 'src_id', 'title', 'dataset', 'variants', 'types', 'ccodes', 'parents', 'descriptions', 'geoms', 'timespans', 'links']-->
				        <div id="review_list" class="col-sm-8 pe-0">
				          	{% for form in formset %}
					            <input type="hidden" name="id" value='{{ form.id.value }}'></input>
					            <input type="hidden" name="authrecord_id" value='{{ form.authrecord_id.value }}'></input>
					            <input type="hidden" name="score" value='{{ form.score.value }}'></input>
					            <input type="hidden" name="query_pass" value='{{ form.query_pass.value }}'></input>
					            {% for hidden in form.hidden_fields %}
					              	{{ hidden }}
					            {% endfor %}
				            	<div class="ps-2 pe-2 mb-1 matchbar">
				              		<div class="match_radio custom-control custom-radio ps-1">
					              		{% for choice in form.match %}{{ choice }}&nbsp;{% endfor %}
				                		<span class="help" data-id="matches"><i class="fas fa-question-circle linkypop"></i></span>
					                		{% if form.json.value|get:"sources" %}
					                			<span class="float-end me-1 mt-1 smaller">
						                			{{ form.json.value|get:"whg_id" }}&nbsp;&nbsp;{{ form.json.value|get:"sources"|length }} linked records <i class="fas fa-link linky"></i>
					                			</span>
					                		{% endif %}
				                		</span>
				              		</div>
				            	</div>
				            	{{ form.non_field_errors }}
				            	<div class="auth-match bg-white ps-2 mt-0 mb-2">
				              		<!-- pull geometries to js -->
				              		{% if form.json.value|get:"geoms"|length > 0 %}
				                		{% for g in form.json.value|get:"geoms" %}
				                  			{{ g|safe|json_script:g.id }}
				                		{% endfor %}
				              		{% endif %}
				              		<p><strong>Title(s)</strong>: <span class="text-danger h6">{{ form.json.value|get:"titles" }}</p>
				              		{% if form.json.value|get:"countries"|length > 0 %}
				                		<p><strong>Countries</strong>: {{ form.json.value|get:"countries" }}</p>
				              		{% endif %}

					              	<p class="mb-0"><strong>Linked records ({{ form.json.value|get:"sources"|length }})</strong>:
						              	{% for src in form.json.value|get:"sources" %}
						                	<div class="accession-div-row hovermap" data-id="{{ src.pid }}">
						                		<p>
						                  			<a class="geolink" data-id="{{ src.pid }}" rel="tooltip" id="{{ src.pid }}"
						                     			href="javascript:void(0)">
							                  			<i class="fas fa-globe" style="color:#ED7702;"></i>
						                  			</a>
							                		<a class="pop-link pop-dataset" data-label={{src.dslabel}} data-toggle="popover" title="Dataset Profile" data-content="" tabindex="0" rel="clickover">{{ src.dslabel }}</a> (<a href="/api/place/{{src.pid}}/" target="_blank">{{ src.pid }}</a>):
									                {% if src.variants|length > 0 %}<i>variants</i>: <b>{{ src.variants|join:", " }}</b>{% endif %}
									                {% if src.types|length > 0 %}; <i>type(s)</i>: <b>{{ src.types|join:","}}</b>{% endif %}
													{# index has some nulls in minmax #}
						                			{% if src.minmax and src.minmax.first != None %}; <i>earliest/latest</i>:<b> {{ src.minmax|join:"/"}}</b>{% endif %}
						                			<i class="text-muted">{{ src.pass }}</i>
									                {% if src.related|length > 0 %}<br/><i class="ms-3">relation(s)</i>: <b>{{ src.related|join:","}}</b>{% endif %}
							                	</p>
						                		<p></p>
						                	</div>
						              	{% endfor %}
						            </p>
             							{% if form.json.value|get:"links"|length > 0 %}
						                <p>
						                	<strong>All concordances</strong>:
						                	{% for link in form.json.value|get:"links" %}
						                  		<a href="" class="me-2 ext" data-toggle="modal" data-target="#ext_site">{{ link }}
							                  	<i class="fas fa-external-link-alt linky"></i></a>
						                	{% endfor %}
						              	</p>
						            {% endif %}
             							{% if form.json.value|get:"minmax"|length > 0 %}
					                	<p><strong>Temporal attestations</strong>:
					                	{{ form.json.value|get:"minmax" }}</p>
					              	{% endif %}
			            		</div>
			          		{% endfor %}
			        	</div> <!-- review_list -->
			      </div> <!-- .row -->
			    </div> <!-- container flex -->
   			{% endfor %} <!-- record in records -->
   		</form>
	{% endif %}
	<div class="modal fade" tabindex="-1" role="dialog" id="modal">
		<div class="modal-dialog modal-form" role="document">
 			<div class="modal-content"></div>
		</div>
	</div>
	<div class="selector py-3"><div id="helpme" class="my-3">
 		<div></div>
	</div>
</div>

<script src="{% static 'js/jquery.bootstrap.modal.forms.min.js' %}"></script>

<!-- Set up MapLibre map using Maptiler SDK -->
<script type="text/javascript">
    let mapParameters = {
        container: 'map',
        center: [9.2, 33],
        zoom: 0.2, // starting zoom
        minZoom: 0.1,
        maxZoom: 10,
        mapTilerKey: '{{ maptilerkey }}',
        controls: {
            layer: true,
            navigation: true,
            fullscreen: false,
            attribution: {
                open: false,
            },
            temporal: false
        },
        styleFilter: [ /* 'TOPO.PASTEL','BASIC.DEFAULT' */ ], // Leave empty for full list of options, or include a single style to prevent selector inclusion
    }
    const featureCollectionJSON = '{{ feature_collection|safe }}';
    let already = '{{ already }}';
    let ds_label = '{{ ds_label }}';
    let test = '{{ test }}';
    let passnum = '{{ passnum }}';
    let mbtoken = '{{ mbtoken }}';
    let page_variant = 'accession';
</script>

<script type="module">
    import "{% static 'webpack/maptiler_sdk.bundle.js' %}";
    import "{% static 'webpack/review.bundle.js' %}";
</script>

{% endblock %}
