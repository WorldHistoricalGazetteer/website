{% extends "main/base.html" %}
{% load static %}

{% load mathfilters %}
{% load dataset_extras %}

{% block extra_head %}
  <script src="{% static 'js/aliases.js' %}"></script>
  <link rel="stylesheet" href="{% static 'css/spin.css' %}"/>
  <script src="{% static 'celery_progress/celery_progress.js' %}"></script>
  <style>
    .badge {letter-spacing: 1px; }
    .badge-completed { background-color: #0a5eb0; color: white; opacity: 0.5;}
    .badge-current { background-color: #0a5eb0; color: white; }
    .badge-future { background-color: gainsboro; color: black; }
    #ds_summary_guide p { font-size: .9rem; margin-bottom: .3rem; }
    #ds_summary_blurb {
      outline: 1px solid #ccc;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 8px;
      font-size: .8rem;
    }
    {##ds_summary_blurb p { font-size: .8rem;}#}
  </style>
{% endblock %}

{% block title %}<title>Dataset::{{ ds.label }}</title>{% endblock %}

{% block content %}
<div id="dataset_content" class="container mt-1 px-1">
  {% if not user in owners and not user in collaborators and not user.is_superuser %}
    <p>Access to this page is limited to the dataset owner and designated collaborators</p>
  {% else %}
    <div>
  {# all tabs, but only content for summary #}
  <ul id="dataset_tabs" class="nav nav-tabs" role="tablist">
      <li class="nav-item">
          <a class="nav-link active" id="summary-tab" data-link="summary" href=""
             role="tab" aria-controls="summary" aria-selected="false">Dataset Summary</a>
      </li>
      <li class="nav-item">
          <a class="nav-link" id="browse-tab" href="{% url 'datasets:ds_browse' id=ds.id %}"
             role="tab" aria-controls="browse" aria-selected="false">Browse</a>
      </li>
      <li class="nav-item">
          <a class="nav-link" id="reconciliation-tab" href="{% url 'datasets:ds_reconcile' id=ds.id %}"
             role="tab" aria-controls="reconciliation" aria-selected="false">Linking</a>
      </li>
      <li class="nav-item">
          <a class="nav-link" id="metadata-tab" data-link="metadata" href="{% url 'datasets:ds_metadata' id=ds.id %}"
             role="tab" aria-controls="metadata" aria-selected="false">Metadata</a>
      </li>
      <li class="nav-item">
          <a class="nav-link" id="sharing-tab" href="{% url 'datasets:ds_collab' id=ds.id %}"
             role="tab" aria-controls="sharing" aria-selected="false">Collaborators</a>
      </li>
      <li class="nav-item">
          <a class="nav-link" id="log-tab" data-link="log" href="{% url 'datasets:ds_log' id=ds.id %}"
             role="tab" aria-controls="log" aria-selected="false">Log & Comments</a>
      </li>
  </ul>
    </div>
  <div class="tab-content">
    <div id="summary" class="tab-pane fade show active" role="tabpanel" aria-labelledby="summary-tab">
      <div class="row">
        <div id="ds_summary_guide" class="col-md-7">
          <div class="row mb-2">

            <div id="status_badges" class="col-12 large">
              {% if ds.ds_status|lower == 'uploaded' %}
                <span class="badge badge-completed">Uploaded <i class="fas fa-check"></i></span>
                <span class="badge badge-future">Reconciling</span>
                <span class="badge badge-future">Reconciled</span>
                <span class="badge badge-future">Published</span>
                <span class="badge badge-future">Accessioning</span>
                <span class="badge badge-future">Indexed</span>
              {% elif ds.ds_status|lower == 'reconciling' %}
                <span class="badge badge-completed">Uploaded <i class="fas fa-check"></i></span>
                <span class="badge badge-current">Reconciling</span>
                <span class="badge badge-future">Reconciled</span>
                <span class="badge badge-future">Published</span>
                <span class="badge badge-future">Accessioning</span>
                <span class="badge badge-future">Indexed</span>
              {% elif ds.ds_status|lower == 'wd-complete' and ds.public %}
                <span class="badge badge-completed">Uploaded <i class="fas fa-check"></i></span>
                <span class="badge badge-completed">Reconciling <i class="fas fa-check"></i></span>
                <span class="badge badge-completed">Reconciled <i class="fas fa-check"></i></span>
                <span class="badge badge-current">Published</span>
                <span class="badge badge-future">Accessioning</span>
                <span class="badge badge-future">Indexed</span>
              {% elif ds.ds_status|lower == 'wd-complete' %}
                <span class="badge badge-completed">Uploaded <i class="fas fa-check"></i></span>
                <span class="badge badge-completed">Reconciling <i class="fas fa-check"></i></span>
                <span class="badge badge-current">Reconciled</span>
                <span class="badge badge-future">Published</span>
                <span class="badge badge-future">Accessioning</span>
                <span class="badge badge-future">Indexed</span>
              {% elif ds.ds_status|lower == 'accessioning' %}
                <span class="badge badge-completed">Uploaded <i class="fas fa-check"></i></span>
                <span class="badge badge-completed">Reconciling <i class="fas fa-check"></i></span>
                <span class="badge badge-completed">Reconciled <i class="fas fa-check"></i></span>
                <span class="badge badge-completed">Published <i class="fas fa-check"></i></span>
                <span class="badge badge-current">Accessioning</span>
                <span class="badge badge-future">Indexed</span>
              {% elif ds.ds_status|lower == 'indexed' %}
                <span class="badge badge-completed">Uploaded <i class="fas fa-check"></i></span>
                <span class="badge badge-completed">Reconciling <i class="fas fa-check"></i></span>
                <span class="badge badge-completed">Reconciled <i class="fas fa-check"></i></span>
                <span class="badge badge-completed">Published <i class="fas fa-check"></i></span>
                <span class="badge badge-completed">Accessioning <i class="fas fa-check"></i></span>
                <span class="badge badge-current">Indexed</span>
              {% endif %}
            </div>

          </div>
          <div id="status_message">
          {% if ds.ds_status == 'uploaded' %}
            <p>Your dataset is uploaded to the WHG database and so far visible only in this private workspace.
              Its records can be examined in the table and map under the
              <a href="{% url 'datasets:ds_browse' id=ds.id %}">Browse</a> tab. WHG offers a reconciliation tool
              that aids in finding close matches for your records in our index of Wikidata and GeoNames records.
            </p>
            <p>Of your <mark>{{ ds.numrows }}</mark> records, <mark>{{ num_geoms }}</mark> have geometries,
              and there are <mark>{{ num_names }}</mark> name variants and <mark>{{ num_links }}</mark> links to other
              records among them.
            </p>
            {% if num_geoms >= numrows %}
              <p>Because there is geometry for all records, reconciliation is not essential for this dataset.
              However, it can augment your data with additional name variants and links not only to Wikidata
                and GeoNames but to authority records from <a href="" class="linkypop">other resources</a>.
              </p>
              <p>Alternatively, you can complete its metadata and request publication as is,
                which will make it visible to the public and available for download.
              </p>
            {% else %}
              <p>Because not all records have geometries, reconciliation is recommended for this dataset.
                It can also augment your data with additional name variants and links not only to Wikidata
                and GeoNames but to authority records from <a href="" class="linkyred">other resources</a>.
              </p>
            {% endif %}
            <p class="fs6 text-center">
              <a class="btn btn-sm btn-outline-primary" href="{% url 'datasets:ds_addtask' ds.id %}">
                Start a reconciliation task</a>
              <a class="btn btn-sm btn-outline-primary" href="{% url 'contact' %}">Request publication</a>
            </p>
          {% elif ds.ds_status == 'reconciling' %}
            <p>The reconciliation task below has been run and review of its results is in progress. So far,
              candidate matches for <mark>{nn}</mark> records have been reviewed, and <mark>{nn}</mark> remain.</p>
            <div class="task-box p-1">WDGN reconciliation task</div>
          {% elif ds.ds_status == 'wd-complete' and ds.public %}
            <p>Your dataset has been published! It is now visible to all site visitors in its
              <a href="{% url 'datasets:ds_places' ds.id %}" target="_blank">publication page</a>, and its records are accessible
            via the WHG search and API features. Many thanks for this contribution!</p>
            <p>A next step we strongly encourage is to fully accession its records in the WHG platform by reconciling
              them against the <mark>{nn}</mark> records already in our <i><strong>union index</strong></i>.</p>
          {% elif ds.ds_status == 'wd-complete' %}
            <p>Results from the reconciliation task below have been reviewed! If you would like to publish this
              dataset in the World Historical Gazetteer platform, please complete its metadata, then
              <a href="">submit a request to WHG editors</a>. Once published its presentation page will be
            publicly viewable and its data included in search results.</p>
          {% elif ds.ds_status == 'accessioning' %}
            <p>Your dataset is already published, and now in the process of accessioning to the WHG "union index,"
              linking individual records with any close matches to records from other datasets already in the index.
              The accessioning task shown below indicates progress toward completion. Candidate matches for
              <mark>{nn}</mark> records remain to be reviewed.</p>
            <p>If you would like to list your dataset on WHG's <a href="">Match Review Contribution Board</a>, please
              let us know: <a class="btn btn-sm btn-outline-primary" href="">Request review help</a></p>
            <div class="task-box p-1">WHG union index accessioning task</div>
          {% elif ds.ds_status == 'indexed' %}
            <p>Congratulations! Your dataset is now fully accessioned in World Historical Gazetteer, <mark>{n}</mark>
            of its records were linked with records from other datasets, and <mark>{nn}</mark> are for places
            we did not yet have represented. Many thanks!</p>
          {% endif %}
          </div>
          <div id="ds_summary_blurb" class="mt-3">
            <h5>
              {{ form.title.value }} <span class="float-end fs-6">({{ ds.label }} / {{ ds.id }})</span>
              {% comment %}
              <span class="float-end fs-5">
                <span class="badge bg-beige text-dark">{{ ds.ds_status }}</span>
                <a href=""><i class="fas fa-question-circle red-head fs-6"></i></a>
              </span>{% endcomment %}
            </h5>
            <p class="small mb-1">
              {% if ds.creator %}<i>Created by</i>: <strong>{{ ds.creator }}</strong>; {% endif %}
              {% if ds.contributors %}Contributed by:<strong>{{ ds.contributors }}</strong>{% endif %}
            </p>
            <p>{{ form.description.value|trunc_it:300 }}</p>
            <p>
              {% if ds.image_file %}<strong><a href="/media/{{ form.image_file.value}}">Image file</a></strong>{% endif %}
              {% if ds.pdf %}Essay: <strong>{{ form.pdf.value}}</strong>; {% endif %}
            </p>
          </div>
          <div id="ds_del_view">
            {% if user == object.owner or user.is_superuser %}
              <span class="float-end">Delete dataset
                <a href="{% url 'datasets:dataset-delete' ds.id %}" class="" data-bs-toggle="tooltip">
                  <i class="fas fa-trash linkyred"></i></a>
              </span>
            {% endif %}
              {% if user in collaborators or is_admin %}
              <span class="float-end me-3">
                publication {% if not ds.public %}pre{% endif %}view
                <a href="{% url 'datasets:ds_places' id=ds.id %}" title="View publication page" data-bs-toggle="tooltip">
                <i class="fas fa-eye"></i></a>
              </span>
            {% endif %}
          </div>
        </div>
        <div id="ds_summary_detail" class="col-md-5 small">
          <div id="ds_info">
            <div id="ds_stats" class="ds-card">
              <table style="width:100%">
                <tr><th></th><th class="pb-1 text-secondary">count</th><th class="pb-1 text-secondary">added</th></tr>
                <tr><td><b>Records</b></td><td>{{ ds.numrows }}</td><td class="text-secondary">n/a</td></tr>
                <tr><td><b>Name variants</b></td><td>{{ num_names }}</td><td class="text-secondary">n/a</td></tr>
                <tr>
                  <td><b>Geometries</b></td><td>{{ num_geoms }}</td>
                  <td><span class="text-white bg-success">&nbsp;{{ geoms_added }}&nbsp;</span></td></tr>
                <tr>
                  <td><b>Links</b></td><td>{{ num_links }}</td>
                  <td><span class="text-white bg-success">&nbsp;{{ links_added }}&nbsp;</span></td></tr>
                  {% if ds.unindexed > 0 %}
                  <tr class="text-danger">
                    <td class="pt-3"><b>Unindexed records</b></td>
                    <td class="pt-3">{{ ds.unindexed }}</td>
                    <td class="pt-3 text-secondary">n/a</td>
                  </tr>
                  {% elif ds.numrows > 0 %}
                    <tr class="text-danger"><td><b>Dataset is fully indexed!</b></td></tr>
                  {% endif %}
              </table>
            </div>
            <div id="ds_access" class="pt-0 px-0 ds-card">
              <p class="ds-card-header">Collaboration</p>
              <p class="m-0 ps-2 pe-2">This screen and the tasks made available here are initially accessible only to the dataset "owner" - the user who created the record by uploading a dataset file. Dataset owners can then grant "co-owner" and/or "member" permissions to other registered users under the <a href="{% url 'datasets:ds_collab' ds.id %}">Collaborators</a> tab.</p>
            </div>
            {% if user.is_superuser or user in owners %} <!-- must be or they wouldn't see this! -->
              <div id="ds_downloads" class="pt-0 px-0 ds-card">
                <p class="ds-card-header pt-1"> Downloads
                  <span id='progress-bar' class='progress-bar' style="background-color: #68a9ef; width: 0%; line-height:.5rem;">&nbsp;</span>
                </p>
                {# TODO: review download size cases #}
                <!-- if length <= 20k -->
                {% if ds.numrows <= 25000 %}
                  <!-- lptsv originally -->
                  {% if current_file.format == 'delimited' %}
                    <!-- offer lpf, augmented or not -->
                    <p><a class="a-dl-celery" href="#" ref="lpf">
                      Linked Places format <i class="fas fa-download linky"></i></a>
                      <span id="file_lpf" class="ms-1"></span></p>
                    {% if links_added > 0 or geoms_added > 0 %}
                      <!-- augmented, offer tsv -->
                      <p><a class="a-dl-celery" href="#" ref="tsv">LP-TSV (augmented)
                        <i class="fas fa-download linky"></i></a>
                        <span id="file_tsv" class="ms-1"></span></p>
                    {% endif %}
                  <!-- lpf originally -->
                  {% elif links_added > 0 or geoms_added > 0 %}
                    <!-- offer dl if augmented -->
                    <p><a class="a-dl-celery" href="#" ref="lpf">Linked Places format <i class="fas fa-download linky"></i></a> (augmented) <span id="file_lpf" class="ms-1"></span></p>
                    <p class="mt-2"><i>LP-TSV conversion is not possible for this LPF dataset. <a id="conversion_help" class="pointer" data-toggle="popover" title="LPF download options" data-content="<p>Data initially loaded in Linked Places format (LPF) has one&#8209;to&#8209;many relations that can't be converted to simple TSV files.</p>" tabindex="0" data-trigger="focus" data-original-title=""><i title="" class="fa fa-question-circle" style="color:#336699;"></i></a></i></p>
                  {% else %}
                    <!-- originally lpf, not yet augmented -->
                    <p><i>Dataset is not yet augmented</i></p>
                  {% endif %}
                <!-- more than 20k rows -->
                {% else %}
                  <span class="red-head"><br/>Download of augmented datasets larger than 25,000 rows is not supported right now. <a href="{% url 'contact' %}">Contact WHG staff</a></span>
                {% endif %}
                <div id="progress-bar-message" class="hidden">Waiting for progress to start...</div>
                <div id="celery-result"></div>
              </div> <!-- ds_downloads_ajax -->
            {% endif %} <!-- owner or superuser -->
          </div> <!-- ds_info -->
        </div> <!-- ds_details -->
      </div> <!-- row -->
      </form>
    </div> <!-- summary -->
  </div> <!-- .tab-content -->
  <div class="modal fade" id="updateModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="updateModalLabel">
            Update <span class="text-danger">{{ ds.label }}</span> dataset <small>(<i>{{ current_file.format }} file only</i>)</small>
          </h5>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <form id="newfileform" method="POST" action="#" enctype="multipart/form-data">
              {% csrf_token %}
              <div id="loadfile">
                <p><input type="file" id="newfile"></p>
                <button id="btn_upload" type="submit" class="btn btn-primary btn-sm hidden">Upload</button>
              </div>
              <div id="update_spinner"></div>
              <div id="results_text" class="mb-2 small ds-card">
                <p>Uploaded data will be compared with existing data, and results reported here.</p>
                  <p>You may then proceed, or cancel this operation with no changes made.</p>
                {% if links_added > 0 or geoms_added > 0 %}
	                <p class="mt-3"><b>NOTE:</b> This dataset has been augmented with {{ links_added }} links and {{ geoms_added }} geometries
                via reconciliation tasks. These can be preserved for records that are not modified or deleted in the update file.</p>
                {% endif %}
              </div>
            </form>
          </div> <!-- .form-group -->
        </div> <!-- .modal-body -->
        <div class="modal-footer">
          <div id="buttons_pre">
            <button id="btn_cancel" type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Cancel</button>
            <button id="btn_update" type="button" data-dsid='{{ds.id}}' class="btn btn-primary btn-sm hidden">Proceed</button>
          </div>
          <button id="btn_done" type="button" class="btn btn-primary btn-sm hidden" data-dismiss="modal">Done</button>
        </div>
      </div>
    </div>
  </div>
  <!-- .selector is div for modal help, can be placed anywhere-->
  <div class="selector py-3"><div id="helpme"></div></div>
  {% endif %}
</div>

<script type="text/javascript">

  dater = function(){
    const date = new Date(Date.now());
    return date.toISOString().substring(0,10)
  }

  $(".feedback").click(function(){
  console.log(clicked)
  url=window.location.href="/contact?from="+clicked
  window.location.href=url
  console.log('gwine to contact form, from clicked',url)
  })

  clearEl = function(el){
    $("#progress-bar").fadeOut()
    el.html('')
  }

  // post-download actions
  function customResult(resultElement, result) {
    console.log('celery result',result)
    console.log('celery resultElement',resultElement)
    spinner_dl.stop()
    fn = result.filename
    link = '[ <span class="dl-save"><a href="/'+fn+'" title="downloaded: '+dater()+
              '" download>save</a></span> ]'
    $( resultElement ).append(
      $('<p>').html(link)
    );
    $(".dl-save a")[0].click()
    setTimeout(clearEl($("#celery-result")), 1000)
  }

  // views_dl.downloader()
  $(".a-dl-celery").click(function(e){
    e.preventDefault()
    // startDownloadSpinner()
    console.log('sending post')
    console.time('dl')
    format = $(this).attr('ref')
    dsid = '{{ ds.id }}'
    console.log('send to downloader()')
    urly='/dlcelery/'
    $.ajax({
        type: 'POST',
        url: urly,
        data: {
          "format":format,
          "dsid":dsid,
          "csrfmiddlewaretoken":"{{ csrf_token }}"},
        datatype:'json',
        success:function(response){
          startDownloadSpinner()
          console.log('got task_id',response)
          task_id = response.task_id
          var progressUrl = "/celery-progress/"+task_id+"/";
          CeleryProgressBar.initProgressBar(progressUrl,
            { pollingInterval: 500,
              onResult: customResult,
            }
          )
        }
      })
  })


  $("#a_update_modal").on('click', function(e){
    console.log('clicked update')
    if('{{ current_file.format }}' != 'delimited'){
        alert('Sorry, update is available only for delimited files right now. Soon...')
      }
  })

  // show upload button after file selected
  $("#newfile").on("change", function() {
    $("#btn_upload").removeClass('hidden')
  });

  $("#btn_done").on('click', function(){ location.reload(); })
  $("#btn_cancel").on('click', function(){ location.reload(); })

  function startUpdateSpinner(){
    window.spinner_update = new Spin.Spinner().spin();
    $("#update_spinner").append(spinner_update.el);
  }
  function startDownloadSpinner(){
    window.spinner_dl = new Spin.Spinner().spin();
    $("#ds_downloads").append(spinner_dl.el);
  }

  // parse & prettify ds_update() results
  // [status,format,update_count,redo_count,new_count,deleted_count,newfile]
  function updateText(data){
    html = 'Changes in database: <br/>' + '<ul>' +
           '<li>Added '+data["new_count"]+' rows </li>'+
           '<li>Deleted '+data["deleted_count"]+' rows </li>'+
           '<li>Updated '+data["update_count"]+' rows </li>'+'</ul>'
	  html += 'A followup reconciliation to Wikidata task is required.'

		if(data['indexed'] == true) {
      html += ', as well as a reindexing, in order to account for these changes.'
		}
    return html
  }
  // performs ds_update()
  $("#btn_update").on('click', function(){
    console.log('compare_data', compare_data)
    startUpdateSpinner()
    var formData = new FormData();
    formData.append('dsid', '{{ ds.id }}');
    formData.append('format', '{{ current_file.format }}');
    formData.append('keepg', $("#preserve_geoms").length ? $('#preserve_geoms')[0].checked : "true");
    formData.append('keepl', $("#preserve_links").length ? $('#preserve_links')[0].checked : "true");
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('compare_data',JSON.stringify(compare_data));

    $.ajax({
      type: 'POST',
      enctype: 'multipart/form-data',
      url: '/datasets/update/',
      processData: false,
      contentType: false,
      cache: false,
      data: formData,
      success:function(data){
        console.log('update result data',data)
        $("#buttons_pre").addClass('hidden')
        $("#btn_done").removeClass('hidden')
        html = '<h6>update complete!</h6>'
        html += updateText(data)
        $("#results_text").html(html)
        spinner_update.stop()
      }
    })
  })

  // parse & prettify ds_compare() results
  function comparisonText(data) {
      stats = data['compare_result']
      keepg = data['keepg']; keepl = data['keepl'];
      html = 'This action would perform these WHG <i>database</i> updates:<br/><ul style="padding:0;list-style: inside;">'
      html += '<li>Update <b>'+stats['count_replace']+'</b> place record(s) having same source IDs </li>'
      html += stats['rows_add'].length >0?'<li>Add '+stats['rows_add'].length+' record(s): (<b>'+stats['rows_add'].join(', ')+'</b>)</li>':''
      html += stats['rows_del'].length >0?'<li>Remove '+stats['rows_del'].length+' record(s): (<b>'+stats['rows_del'].join(', ')+'</b>)</li>':''
      html += stats['cols_add'].length >0?'<li>Add column(s): (<b>'+stats['cols_add']+'</b>)</li>':''
      html += stats['cols_del'].length >0?'<li>Remove column(s): (<b>'+stats['cols_del']+'</b>)</li>':''
      if (data['count_geoms_added'] > 0){
        html += '<li class="text-danger">Keep <b>'+data['count_geoms_added']+
		        '</b> existing place-geometry records from prior reconciliation)'+
        ' <input type="checkbox" id="preserve_geoms" checked></li>'
      }
      if (data['count_links_added'] > 0){
        html += '<li class="text-danger">Keep <b>'+data['count_links_added']+
		        '</b> existing place-link records from prior reconciliation)'+
        ' <input type="checkbox" id="preserve_links" checked></li>'
      }
      html += '</ul>'
      {#html += data['count_indexed'] > 0 ? '<p>Also, in the WHG <u>index</u>, <b>'+stats['count_replace'] + '</b> records would be updated, and <b>'+stats['rows_del'].length+'</b> removed.</p>':''#}
      html += stats['rows_add'].length >0 ? '<b>NOTE:</b><br/>' +
		      'The '+stats['rows_add'].length+' new record(s) and any being modified will have to be reconciled.':''
		  html += data['count_indexed'] > 0 ? '<br/>Following that, the new and/or modified records will need re-indexing.':''
    return html
  }

  // submit new file for comparison
  // prepares compare_data{} object, passed to ds_update if/when 'proceed' is clicked
  $(document).on('submit', '#newfileform', function(e){
    e.preventDefault()
    var formData = new FormData();
    formData.append('file', $('#newfile')[0].files[0]);
    formData.append('dsid', '{{ ds.id }}');
    formData.append('format', '{{ current_file.format }}');
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    $.ajax({
      type: 'POST',
      enctype: 'multipart/form-data',
      url: '/datasets/compare/',
      processData: false,
      contentType: false,
      cache: false,
      data: formData,
      success:function(data){
        console.log('data returned',data)
        if('failed' in data){
          errors = data['failed']['errors']
          html = '<b class="text-danger">Data validation issue(s):</b> <ul class="ul-flush">'
          var i = 0; i < 9; i++
          for(var i=0; i<errors.length; i++){
            html += '<li class="li-flush">'+errors[i]+'</li>'
          }
          html+='</ul><p>Please correct and try again</p>'
        } else {
          html = '<b>Current file</b>: <i>'+data['filename_cur']+'</i><br/>'
          html += '<b>New file</b>: <i>'+data['filename_new']+'</i><br/>'
          html += '<b>New temp file</b>: <i>'+data['tempfn']+'</i><br/>'
          html += '<b>Indexed?</b>: <i>'+(data['count_indexed']>0?"Yes":"No")+'</i><br/>'
          html += '<b>Validation result</b>: <i>' +
            (data['validation_result']['errors'].length <1?'format valid':data['validation_result']['errors'])+'</i><hr/>'
          html += comparisonText(data)
          $("#btn_update").removeClass('hidden')
        }
        $("#loadfile").addClass('hidden')
        $("#results_text").html(html)
        compare_data=data
      }
    })
  })

  $('.vocab').on('click', function(e) {
    console.log('id',$(this).data('id'))
  });

  $(function(){
	  // activate all tooltips
    $("[data-bs-toggle='tooltip']").tooltip();
    $("[data-toggle=popover]").popover({html:true})

    // help modals
    $(".help-matches").click(function(){
      page=$(this).data('id')
      console.log('help:', page)
      $('.selector').dialog('open');
    })
    $(".selector").dialog({
      resizable: false,
      autoOpen: false,
      height: $(window).height() * 0.9,
      width: $(window).width() * 0.8,
      title: "WHG Help",
      modal: true,
      buttons: { 'Close': function() {console.log('close dialog'); $(this).dialog('close');} },
      open: function(event, ui) {
        $('#helpme').load('/media/help/'+page+'.html')
      },
      show: {effect: "fade",duration: 400 },
      hide: {effect: "fade",duration: 400 }
    });

    if('{{ status }}' == 'updating'){
      console.log('{{ status }}','{{ context }}')
      $("#ds_info").addClass('hidden')
      $("#ds_updating").removeClass('hidden')
      $("#div_file").toggleClass('border-red')
      $(".update-msg").removeClass('hidden')
    }

    window.dslabel = "{{ ds.label }}"

  })

  // TODO: refactor this unholy mess
  // also, button is hidden on 2nd click
  $(".edit-title").click(function() {
    $(".editing-title").toggleClass("hidden")
    $(".form-title").toggleClass("hidden")
    $(".btn-ds").toggleClass("hidden")
  })
  $(".edit-description").click(function() {
    $(".editing-description").toggleClass("hidden")
    $(".form-description").toggleClass("hidden")
    $(".btn-ds").toggleClass("hidden")
  })
  $(".edit-public").click(function() {
    console.log('edit-public')
    $(".editing-public").toggleClass("hidden")
    $(".form-public").toggleClass("hidden")
    $(".btn-ds").toggleClass("hidden")
  })
  $(".edit-creator").click(function() {
    $(".editing-creator").toggleClass("hidden")
    $(".form-creator").toggleClass("hidden")
    $(".btn-ds").toggleClass("hidden")
  })
  $(".edit-source").click(function() {
    $(".editing-source").toggleClass("hidden")
    $(".form-source").toggleClass("hidden")
    $(".btn-ds").toggleClass("hidden")
  })
  $(".edit-contrib").click(function() {
    $(".editing-contrib").toggleClass("hidden")
    $(".form-contrib").toggleClass("hidden")
    $(".btn-ds").toggleClass("hidden")
  })
  $(".edit-citation").click(function() {
    $(".editing-citation").toggleClass("hidden")
    $(".form-citation").toggleClass("hidden")
    $(".btn-ds").toggleClass("hidden")
  })
  $(".edit-uri_base").click(function() {
    $(".editing-uri_base").toggleClass("hidden")
    $(".form-uri_base").toggleClass("hidden")
    $(".btn-ds").toggleClass("hidden")
  })
  $(".edit-webpage").click(function() {
    $(".editing-webpage").toggleClass("hidden")
    $(".form-webpage").toggleClass("hidden")
    $(".btn-ds").toggleClass("hidden")
  })
  $(".edit-featured").click(function() {
    $(".editing-featured").toggleClass("hidden")
    $(".form-featured").toggleClass("hidden")
    $(".btn-ds").toggleClass("hidden")
  })
  $(".edit-image").click(function() {
    $(".editing-image").toggleClass("hidden")
    $(".form-image").toggleClass("hidden")
    $(".btn-ds").toggleClass("hidden")
  })
  $(".edit-pdf").click(function() {
    $(".editing-pdf").toggleClass("hidden")
    $(".form-pdf").toggleClass("hidden")
    $(".btn-ds").toggleClass("hidden")
  })
</script>

{% endblock %}
