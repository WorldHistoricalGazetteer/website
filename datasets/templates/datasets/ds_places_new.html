{% extends "main/base.html" %} 
{% load static %} 
{% load leaflet_tags %} 
{% load mathfilters %} 
{% load dataset_extras %} 
{% block extra_head %} 
	<!-- Datatables does not function with Webpack except in browsers >~ 2021 - see https://datatables.net/blog/2022-11-10-esm -->
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.24/b-1.7.0/b-colvis-1.7.0/b-html5-1.7.0/cr-1.5.3/fh-3.1.8/sc-2.0.3/sp-1.2.2/sl-1.3.3/datatables.min.css" />
	<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.24/b-1.7.0/b-colvis-1.7.0/b-html5-1.7.0/cr-1.5.3/fh-3.1.8/sc-2.0.3/sp-1.2.2/sl-1.3.3/datatables.min.js"></script>
	<!--<script src="https://cdn.maptiler.com/maptiler-sdk-js/v1.1.1/maptiler-sdk.umd.min.js"></script>
  	<link href="https://cdn.maptiler.com/maptiler-sdk-js/v1.1.1/maptiler-sdk.css" rel="stylesheet" />-->
	<link href="{% static 'webpack/whg.bundle.css' %}" rel="stylesheet" />
	<style>
	  #actions {
	    padding-top: 0.2rem;
	  }
	
	  #addtocoll_popup {
	    font-size: 0.8rem;
	    position: absolute;
	    top: 16px;
	    right: 195px;
	    width: 170px;
	    background-color: #fff;
	    border: 1px solid #336699;
	    z-index: 2000;
	    box-shadow: 3px 3px #c3c3c3;
	  }
	
	  #selection_status {
	    position: absolute;
	    top: 10px;
	    right: 10px;
	    display: none;
	  }
	
	  .dataTables_scroll {
	    border-right: 1px solid gainsboro;
	  }
	
	  #dataset_content {
	    position: relative;
	    height: calc(98vh - 60px);
	    overflow-y: auto;
	  }
	
	  #ds_info {
	    transition: height 0.5s;
	    overflow: hidden;
	  }
	
	  #detail {
	    font-size: .8rem;
	    z-index: 10;
	    height: 30% !important;
	  }
	
	  #detail p {
	    margin-bottom: .2rem;
	  }
	
	  .title {
	    font-weight: bold;
	    color: darkblue;
	  }
	
	  #toggleIcon {
	    cursor: pointer;
	    color: #336699;
	  }
	
	  #metadata p {
	    font-size: .9rem;
	  }
	
	  .paginate_button {
	    padding: 0 !important;
	  }
	
	  .dataTables_filter {
	    float: left !important;
	  }
	
	  .dataTables_filter input {
	    padding: 2px;
	  }
	
	  .addtocoll {
	    background-color: aliceblue;
	  }
	</style> 
{% endblock %} 
{% block title %} 
	<title>Dataset::{{ ds.label }}</title>
{% endblock %} 
{% block content %} 
	<div id="dataset_content" class="container mt-1 px-1">
	  <div id="map" style="height:100%;"></div>
	  <div id="ds_info" class="overlay left">
	    <div id="ds_header">
	      <span class="fs-5 title">
	        <img src="{% static 'images/spreadsheet.png'%}" height=28 alt="" />
	        {{ ds.title }}
	      </span>
	      <span class="fs-6"> a WHG dataset</span>
	      <span id="toggleIcon" class="float-end">
	        <span id="iconLabel" class="small">Hide</span>
	        <i id="expandIcon" class="fas fa-chevron-down" style="display: none;"></i>
	        <i id="collapseIcon" class="fas fa-chevron-up"></i>
	      </span>
	    </div>
	    <!-- ds_header -->
	    <div id="metadata" class="mt-2">
	      <div class="row">
	        <div class="col-sm-8">
	          <p>{{ ds.description|safe }}</p>
	        </div>
	        <div class="col-sm-4" style="position: relative;"> {% if ds.image_file %} <a href="#" class="pop">
	            <img id="active_img" class="img-responsive thumbnail float-end"
	                 src="/media/{{ ds.image_file.name }}" width="220px" />
	          </a> {% else %} <span>
	            <i>image here</i>
	          </span> {% endif %} </div>
	      </div>
	      <!-- row -->
	      <!-- id, label, #rows, timespan, last modified WHG permalink
					creator(s), citation -->
	      <div id="ds_details" style="border-top: 1px solid gainsboro;">
	        <p>
	          <b>Creator(s)</b>: {{ ds.creator }} {% if ds.contributors %} <span>
	            <b>Contributor(s)</b>: {{ ds.creator }}
	          </span> {% endif %}
	        </p>
	        <p>
	          <b>Last modified</b>: {{ ds.last_modified_text }}
	        </p>
	        <p>
	          <b>Timespan(s)</b>: earliest: {{ ds.minmax.0 }}; latest: {{ ds.minmax.1 }}
	        </p>
	        <p>
	          <b>WHG Permalink</b>: <a href="https://whgazetteer.org/datasets/{{ds.id}}">https://whgazetteer.org/datasets/{{ds.id}}</a>
	        </p>
	        <p>
	          <span class="">
	            <b>Citation</b>
	            <a id="a_clipcite" class="clippy" data-clipboard-target="#citation" rel="tooltip" title="copy to clipboard">
	              <i class="fas fa-clipboard linky"></i>
	            </a>
	          </span>
	          <span id="citation"> {% if object.citation %} {{ object.citation }} {% else %} {{object.creator}}. {{object.title}}. [Data file, last modified {{ object.last_modified_text}}]. Retrieved from https://whgazetteer.org/datasets/{{object.id}}, {% now 'd M Y' %} {% endif %} </span>
	        </p>
	        <div>
	          <span style="display: block;" class="bg-lighteryellow mt-2">
	            <b>Download options</b>
	          </span> {% if object.numrows <= 25000 %} <p>
	            <a class="a-dl-celery" href="#" ref="lpf">Linked Places format <i class="fas fa-download linky"></i>
	            </a>
	            <span id="file_lpf" class="ms-1"></span>
	          </p> {% if current_file.format == 'delimited' %} <p>
	            <a class="a-dl-celery" href="#" ref="tsv">LP-TSV <i class="fas fa-download linky"></i>
	            </a>
	            <span id="file_tsv" class="ms-1"></span>
	          </p> {% else %} <p class="mt-2">
	            <i>LP-TSV conversion is not possible for this LPF dataset. <a id="conversion_help" class="pointer" data-toggle="popover" title="LPF download options" data-content="
									<p>Data initially loaded in Linked Places format (LPF) has one&#8209;to&#8209;many relations that can't be converted to simple TSV files.</p>" tabindex="0" data-trigger="focus" data-original-title="">
	                <i title="" class="fa fa-question-circle linkypop"></i>
	              </a>
	            </i>
	          </p> {% endif %} {% else %} <span class="red-head">
	            <br />Download of augmented datasets larger than 25,000 rows is not supported right now. </span> {% endif %}
	        </div>
	      </div>
	      <!-- ds_details -->
	      <div class="float-end">
	        <label for="checkbox" class="small">Close intro by default</label>
	        <input type="checkbox" id="checkbox">
	      </div>
	    </div>
	  </div>
	  <!-- ds_info -->
	  <!-- data table -->
	  <div id="ds_table" class="overlay right">
	    <table id="placetable" class="table table-striped table-bordered small" style="width:100%">
	      <thead>
	        <tr>
	          <th>pid</th>
	          <th>title</th>
	          <th>geo</th>
	          <th>
	            <a href="#" rel="tooltip" title="add one or more rows to a collection">
	              <i class="fas fa-question-circle linkypop"></i>
	            </a>
	          </th>
	        </tr>
	      </thead>
	    </table>
	    <div id="selection_status">
	      <span id="actions">
	        <span id="addtocoll" class="float-end ">
	          <a id="addchecked" href="#">add <mark id="sel_count"></mark>to collection <i class="fa fa-plus"></i>
	          </a>
	        </span>
	      </span>
	    </div>
	    <div id="addtocoll_popup" class="p-2 hidden">
	      <div style="position:relative;">
	        <div class="closer" style="position:absolute; top:-6px; right:-2px">x</div>
	      </div>
	      <ul id="my_collections" class="no-bullets"> {% for c in collections %} <li>
	          <a class="a_addtocoll" href="#" ref="{{ c.id }}">{{ c.title }}</a>
	        </li> {% endfor %} </ul>
	      <hr />
	      <p class="mb-0 ital">
	        <a id="create_coll_link" href="#">
	          <i class="fas fa-plus-square linky"></i> create new </a>
	      </p>
	      <p id="title_form" class="small hidden">
	        <input id="title_input" type="text" placeholder="Collection title" width="20" />
	        <button id="b_create_coll" type="button">create</button>
	      </p>
	    </div>
	  </div>
	  <!-- place detail box -->
	  <div id="detail" class="overlay right"></div>
	  <div class="modal fade" id="" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel" aria-hidden="true">
	    <div class="modal-dialog" role="document">
	      <div class="modal-content">
	        <div class="modal-header">
	          <h5 class="modal-title" id="updateModalLabel"></h5>
	        </div>
	        <div class="modal-body"></div>
	        <!-- .modal-body -->
	        <div class="modal-footer">
	          <div id="buttons_pre">
	            <button id="btn_cancel" type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Cancel</button>
	            <button id="btn_update" type="button" data-dsid={{ds.id}} class="btn btn-primary btn-sm hidden"> Proceed</button>
	          </div>
	          <button id="btn_done" type="button" class="btn btn-secondary btn-sm hidden" data-dismiss="modal">Done</button>
	        </div>
	      </div>
	    </div>
	  </div>
	</div>
	<!-- dataset_content -->
	
	<!-- Set up MapLibre map using Maptiler SDK -->
	<script type="text/javascript">
	  const mapParameters = {
	    container: 'map',
	    center: [9.2, 33],
	    zoom: 0.2, // starting zoom
	    minZoom: 0.1,
	    maxZoom: 10,
	    mapTilerKey: 'F8uQKJ8cHQ0tsUSnWKWO', // {{ mbtoken }}
	    controls: {
	      layer: true,
	      navigation: false,
	      fullscreen: false,
	      attribution: {
	        open: false,
	      },
	      temporal: {
	        fromValue: 1550,
	        toValue: 1720,
	        minValue: -2000,
	        maxValue: 2100,
	        open: false,
	        includeUndated: true, // null | false | true - 'false/true' determine state of select box input; 'null' excludes the button altogether
	        epochs: null,
	        automate: null,
	      }
	    },
	    styleFilter: [ /* 'TOPO.PASTEL','BASIC.DEFAULT' */ ], // Leave empty for full list of options, or include a single style to prevent selector inclusion
	  }
	  const pageData = "{{ ds.id }}";
	  window.loggedin = "{{ loggedin }}"
	  window.dslabel = "{{ ds.label }}"
	  window.filter = "{{ filter }}"
	</script>
	
	<script type="module">
	  import "{% static 'webpack/whg.bundle.js' %}";
	</script>
{% endblock %}
