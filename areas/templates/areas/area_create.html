<!-- areas/area_create.html -->
{% extends "main/base.html" %}

{% load static %}
{% load dataset_extras %}
{% block title %}<title>WHG::Create/Update Area</title>{% endblock %}
{% block extra_head %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.min.js" integrity="sha256-LOnFraxKlOhESwdU/dX+K0GArwymUDups0czPWLEg4E=" crossorigin="anonymous"></script>

  <script src="{% static 'js/tags/bootstrap-tagsinput.js' %}"></script>
  <script src="{% static 'js/tags/bloodhound.js' %}"></script>
  <link rel="stylesheet" href="{% static 'js/tags/bootstrap-tagsinput.css' %}"/>
  <link rel="stylesheet" href="{% static 'js/tags/bootstrap-tagsinput-typeahead.css' %}"/>


  <link href="{% static 'webpack/maptiler_sdk.bundle.css' %}" rel="stylesheet" />
  <link href="{% static 'webpack/areas.bundle.css' %}" rel="stylesheet" />

  <script src="{% static 'js/mapbox-gl-draw.js' %}"></script>
  <link href="{% static 'css/mapbox-gl-draw.css' %}" rel="stylesheet" />

{% endblock %}

{% block content %}
<div class="container">
  <h4 class="mt-3">
    {% if action == 'update' %}
        Update Study Area
        <span class="text-danger">"{{ form.title.value }}"</span>
        <span class="ms-3 half">
            (<mark id="count_result">{{ object.count_public }}</mark> places from public datasets lie within this area)
        </span>
        <a href="{% url 'areas:area-delete' object.id %}" class="float-end"
        title="Delete area feature" rel="tooltip" style="margin-top:-2px;">
        <i class="fas fa-trash linkyred"></i></a>
    {% else %}
        Create Study Area
    {% endif %}
  </h4>
  <div class="d-flex">
    <div class="form-box mt-2 col-sm-4">
    <form id="area_form" method="POST" action="#" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="owner" value='{{ user.id }}'></input>
      {% if action == 'update' %}
        <input type="hidden" name="type" value='{{ form.type.value }}' />
      {% else %}
        <input type="hidden" name="type" value='ccodes' />
      {% endif %}
      <p>Title<br/>{{ form.title }}</p>
      <p><span class="top">Description</span><br/>{{ form.description }}</p>
      <hr/>
      <div id="area_options">
        <ul id="area_tabs_ul" class="nav nav-tabs">
          <li class="nav-item">
            <a class="nav-link active" role="tab" data-toggle="tab" ref="ccodes" href="#areas_codes">Countries</a></li>
          <li class="nav-item">
            <a class="nav-link" role="tab" data-toggle="tab" ref="drawn" href="#areas_draw">Draw</a></li>
        </ul>
        <div class="tab-content">
          <div id="areas_codes" class="tab-pane fade active show">
            <p id="p_ccodes">Country codes (ISO 3166 alpha2) &nbsp;<a href="https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2" target="_blank"><i class="fas fa-external-link-alt linky"></i></a><br/>{{ form.ccodes }}
              <span class="float-end ms-1 area-link-clear">
                <a href="javascript:void(0);">clear</a></span>
              <span class="float-end area-link-render">
                <a href="javascript:void(0);">preview</a> |</span>
            </p>
            <p>Buffer (optional, km)<br/>
              <input type="text" id="buffer_km" name="buffer_km" value=""/></p>
          </div>
          <div id="areas_draw" class="tab-pane fade in">
            <p>Use map controls to draw/edit bounding box or polygon</p></div>
        </div>
	      <p class="mt-2">GeoJSON<br/>{{ form.geojson }}</p>
      </div> <!-- area_options -->
      <p id="referrer"></p>
      <input class="btn-sm btn-primary mt-2" type="submit" value="Save" />
      <span title="back"><a href="{% url 'dashboard' %}">Cancel</a></span>
    </form>
    </div>
    <div id="map_container" class="col-sm-8">
    </div>
  </div> <!-- d-flex -->
</div> <!-- container -->

<!-- Set up MapLibre map using Maptiler SDK -->
<script type="text/javascript">
    let mapParameters = {
        container: 'map_container',
        center: [10.2385, 29.8626],
        zoom: 0.1, // starting zoom
        minZoom: 0.1,
        maxZoom: 10,
        mapTilerKey: '{{ maptilerkey }}',
        controls: {
            layer: true,
            navigation: false,
            fullscreen: false,
            attribution: {
                open: false,
            },
            temporal: {
                fromValue: 1550,
                toValue: 1720,
                minValue: -2000,
                maxValue: 2100,
                open: false,
                includeUndated: true, // null | false | true - 'false/true' determine state of select box input; 'null' excludes the button altogether
                epochs: null,
                automate: null,
            }
        },
        styleFilter: [ 'OUTDOOR.DEFAULT', 'SATELLITE.DEFAULT' ], // Leave empty for full list of options, or include a single style to prevent selector inclusion
    }
    let action = '{{ action }}';
    let formType = '{{ form.type.value }}';
    let formGeoJSON = '{{ form.geojson.value|safe }}';
</script>

<script type="module">
    import "{% static 'webpack/maptiler_sdk.bundle.js' %}";
    import "{% static 'webpack/areas.bundle.js' %}";
</script>

{% endblock %}
