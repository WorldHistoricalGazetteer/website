{% extends "main/base.html" %}
{% load leaflet_tags %}
{% load static %}
{% block title %}<title>WHG Search</title>{% endblock %}
{% block extra_head %}
  <script src="{% static 'js/aliases.js' %}"></script>
  <script src="{% static 'js/parents.js' %}"></script>

	<style>
		.container-md {
		    display: flex;
		    flex-direction: column;
		    height: calc(100vh - 65px); /* Adjust the subtraction value as needed */
		}

		#search_content {
		    display: flex;
		    flex-grow: 1;
		    overflow: hidden;
		}

		#search_center {
		    flex-grow: 1;
		    overflow: hidden;
		    display: flex;
		    flex-direction: column;
		}

		#search_results {
			height: 200px;
		    overflow-y: auto;
		    flex-grow: 1;
		}

		.result {
		    border: 1px solid #ccc;
		    {#margin: 10px;#}
		    padding: 10px;
		    border-radius: 5px;
		}

		.result h5 {
		    margin: 0 0 10px;
		    padding: 0;
		}
		.result:hover {
		    background-color: #f0f0f0; /* Adjust hover color as needed */
		}

		.result.selected {
		    background-color: #e0e0e0; /* Adjust selected color as needed */
		}

		.categories {font-variant: small-caps; font-size: .9rem; color:#993333;}
		#adv_checkboxes p {font-size: 0.8rem; margin:0;}
		#adv_checkboxes label {margin-left:2px;}

		#advanced_search {position:absolute; z-index: 1000; opacity: 100%;}
		#result_facets label {font-size: 0.8rem; margin-left: 0.3rem;}
		#type_checkboxes p {margin-bottom:0 !important; font-weight: bold;}
		#country_checkboxes p {margin-bottom:0 !important; font-weight: bold;}
	</style>
{% endblock %}

{% block content %}
  <div class="container-md">

		<!-- Search bar at the top -->
	  <div id="search-bar" class="row bg-light py-2 position-relative">
	    <div id="d_input" class="text-center col-12">
	        <span class="float-start fs-4">Search</span>
	        <div id="input" class="input-group w-50 mx-auto position-relative">
	            <input type="text" id="search-input" class="form-control" placeholder="Enter place name"
	                   aria-label="Search" aria-describedby="search-addon">
	            <span class="input-group-text" id="search-addon">
	                <a href="#" id="a_search"><i class="fas fa-search"></i></a>
	            </span>
	            <a href="#" id="advanced_search-toggle" class="small ps-2">Advanced Search</a>
	        </div>
	    </div>

	    <div id="advanced_search" class="text-center bg-light col-12 w-100"
	         style="background-color: #ffffe0; top: 100%;">
	        <div class="small" mt-2>
						<p><input type="checkbox" id="cb_a" checked="checked" value="A"/>
			        <span for="cb_a"> Administrative entities (A)</span></p>
		        <p><input type="checkbox" id="cb_p" checked="checked" value="P"/>
			        <span for="cb_p"> Cities, towns, hamlets (P)</span></p>
		        <p><input type="checkbox" id="cb_s" checked="checked" value="S"/>
			        <span for="cb_s"> Sites, buildings, complexes (S)</span></p>
		        <p><input type="checkbox" id="cb_r" checked="checked" value="R"/>
			        <span for="cb_r"> Roads, routes, rail... (R)</span></p>
		        <p><input type="checkbox" id="cb_l" checked="checked" value="L"/>
			        <span for="cb_l"> Regions, landscape areas (L)</span></p>
		        <p><input type="checkbox" id="cb_t" checked="checked" value="T"/>
			        <span for="cb_t"> Terrestrial landforms (T)</span></p>
		        <p><input type="checkbox" id="cb_h" checked="checked" value="H"/>
			        <span for="cb_h"> Water bodies (H)</span></p>
					</div>
	        <button id="close-advanced_search" class="btn btn-secondary">Close</button>
	    </div>
		  <div id="advanced_search">
			    <p class="mb-0"><span class="categories ms-1">place categories</span>
            <span class="ms-1 categories">
              <span class="me-1"><a id="check_toggle" href="#">clear all</a></span>
              <a id="filter_help" class="pointer" data-toggle="popover" title="Place categories"
                 data-content="" tabindex="0" data-trigger="focus"><i class="fas fa-question-circle linky"></i></a>
            </span>
          </p>
		      <div id="adv_checkboxes" class="small mt-2 ps-1">
		        <p><input type="checkbox" id="cb_a" checked="checked" value="A"/>
			        <span for="cb_a"> Administrative entities (A)</span></p>
		        <p><input type="checkbox" id="cb_p" checked="checked" value="P"/>
			        <span for="cb_p"> Cities, towns, hamlets (P)</span></p>
		        <p><input type="checkbox" id="cb_s" checked="checked" value="S"/>
			        <span for="cb_s"> Sites, buildings, complexes (S)</span></p>
		        <p><input type="checkbox" id="cb_r" checked="checked" value="R"/>
			        <span for="cb_r"> Roads, routes, rail... (R)</span></p>
		        <p><input type="checkbox" id="cb_l" checked="checked" value="L"/>
			        <span for="cb_l"> Regions, landscape areas (L)</span></p>
		        <p><input type="checkbox" id="cb_t" checked="checked" value="T"/>
			        <span for="cb_t"> Terrestrial landforms (T)</span></p>
		        <p><input type="checkbox" id="cb_h" checked="checked" value="H"/>
			        <span for="cb_h"> Water bodies (H)</span></p>
	        </div>
          <div id="filter_spatial">
            <p class="mb-0"><span class="categories ms-1">spatial</span>
              <span class="float-end">
              <a id="spatial_help" class="pointer" data-toggle="popover"
                 title="Spatial filter" data-content="" tabindex="0" data-trigger="focus">
              <i class="fas fa-question-circle linky"></i></a></span>
            </p>
            <input id="input_area" type="text" size="25" placeholder="Region, country, study area" />
            <input type="hidden" id="boundsobj" />
          </div>
            <button id="close-advanced_search" class="btn btn-sm btn-secondary">Close</button>
		    </div>
		</div>

	  <!-- Main content grid -->
	  <div id="search_content" class="row">
	    <!-- Left column for facets -->
	    <div id="search_left" class="col-2 p-1" style="background-color: #e6e6e6;">
	      <h5>Filter Results</h5>
	      <div id="result_facets" class="p-1 bg-light">
			    <div id="type_checkboxes"></div>
			    <div id="country_checkboxes" class="mt-2"></div>
	      </div>
	    </div>

	    <!-- Center column for search results -->
	    <div id="search_center" class="col-5 p-1" style="background-color: #cccccc;">
				<h5>Results (<span id="result_count"></span>)</h5>
	      <div id="search_results" class="p-1 bg-light"></div>
	    </div>

	    <!-- Right column -->
	    <div id="search_right" class="col-5 px-0">

	      <!-- Map -->
	      <div id="map-container" style="background-color: #e6e6e6;">
	        <div id=map" class="p-3">
	          <label>Map</label>
	        </div>
	      </div>

	      <!-- Detail box -->
	      <div id="detail-box" class="p-1" style="background-color: palegoldenrod;">
	        <h5>Detail</h5>
	        <div id="detail" class="p-3 bg-light">
	        </div>
	      </div>

	    </div>
    </div>

  </div>

  <script type="text/javascript">

    let results = [];
    let checkboxStates = {};
    let allTypes = [];
    let allCountries = [];
    let isInitialLoad = true;
    let initialTypeCounts = {};
    let initialCountryCounts = {};

    $(document).ready(function() {

        // look for last_results
        const storedResults = localStorage.getItem('last_results');
        results = storedResults ? JSON.parse(storedResults) : null;

        // render 'em
        if (results) {
            // Render the results on the page
            renderResults(results);
        } else {
            console.log('no results')
        }

	    // toggler for advanced search
	    $('#advanced_search').hide();

      $('#advanced_search-toggle').click(function() {
          $('#advanced_search').slideToggle(300);
      });

      $('#close-advanced_search').click(function() {
          $('#advanced_search').slideUp(300);
      });

      $("#a_search").on('click', function(event) {
	    event.preventDefault();
	    initiateSearch(); // Call the initiateSearch function when the button is clicked
      });
      $("#d_input input").on('keypress', function(event) {
		    if (event.which == 13) {
		        event.preventDefault();
		        initiateSearch(); // Call the initiateSearch function when 'Enter' is pressed
		    }
			});

    }); // document ready

    // Filter results based on checked checkboxes
    function filterResults(checkedTypes, checkedCountries){
			let filteredResults = results.filter(function(result) {
			    return (checkedTypes.length === 0 || checkedTypes.some(type => result.types.includes(type))) &&
			           (checkedCountries.length === 0 || checkedCountries.some(country => result.ccodes.includes(country)));
			 });
      return filteredResults
    }

    function getCheckedTypes(){
    let checkedTypes = $('.type-checkbox:checked').map(function() {
        return this.value;
    }).get();
        return checkedTypes
    }

    function getCheckedCountries(){
        let checkedCountries = $('.country-checkbox:checked').map(function() {
          return this.value;
        }).get();
        return checkedCountries
    }

    // render results and facet checkboxes
    function renderResults(results){
        console.log('results (global)', results)
        $("#result_count").html(results.length)
        // Clear previous results
        $('#search_results').empty();
        geoms = []
        havegeom = 0

        // Select the search_results div
        const $resultsDiv = $('#search_results');

        // search term to search input
        const lastQuery = localStorage.getItem('last_query');
        $("#d_input input").val(lastQuery);
            localStorage.removeItem('last_query');

        // Iterate over the results and append HTML for each
          // NB these are parents only
          // hit (delivers): [title, searchy, whg_id, pid, linkcount, variants,
          //    ccodes, fclasses, types, geoms]
          // hit (also): [uri, names, links, timespans, dataset]
          // link to portal: <a href="/places/${result.whg_id}/portal">portal</a>
        results.forEach(result => {
            const count = parseInt(result.linkcount)+1
            const html = `
                <div class="result">
                    <h5>${result.title} (${count} in set)
                                        <span class="float-end">
                                            <a href="JavaScript:alert('not live in dev')">portal ${result.whg_id}</a>
                                        </span>
                                    </h5>
                    {#<p>Country Codes: ${result.ccodes.join(', ')}</p>#}
                    {#<p>Feature Classes: ${result.fclasses.join(', ')}</p>#}
                    {#<p>Types: ${result.types.join(', ')}</p>#}
                </div>
            `;
            $resultsDiv.append(html);
                    // result.geom is an array
                if(!!result.geom) {
              havegeom +=1
              result.geom.forEach(function(g){
                g['properties']['title'] = result.title
                g['properties']['whgid'] = result.whg_id
                {#g['properties']['whgid'] = (doctype=='place')?sug.whg_id:sug.place_id#}
                geoms.push(g)
              })
            }

            {#result.types.forEach(type => typesSet.add(type));#}
            {#result.ccodes.forEach(ccode => countriesSet.add(ccode));#}

        });

        if(isInitialLoad) {
            // sets values of global variables
            allTypes = getAllTypes(results);
            allCountries = getAllCountries(results);
            isInitialLoad = false;

            console.log('allTypes', allTypes)
            console.log('allCountries', allCountries)
        }
        $('.result').first().addClass('selected');

        // checkboxes for types in intial results
        $('#type_checkboxes').empty().append('<p>Place Types</p>');
        {#types.forEach(type => {#}
        allTypes.forEach(type => {
            const checkbox = $('<input>', {
              type: 'checkbox',
                  id: 'type_' + type,
                  value: type,
                  class: 'filter-checkbox type-checkbox',
                  checked: checkboxStates[type] || false
            });
            const count = initialTypeCounts[type] || 0;
            const label = $('<label>', { 'for': 'type_' + type, text: `${type} (${count})` });
            $('#type_checkboxes').append(checkbox).append(label).append('<br>');
        });

        // checkboxes for countries in initial results
        $('#country_checkboxes').empty().append('<p>Countries</p>');
        {#countries.forEach(country => {#}
        allCountries.forEach(country => {
            const cName = ccode_hash[country]['gnlabel'];
            const checkbox = $('<input>', {
              type: 'checkbox',
              id: 'country_' + country,
              value: country,
              class: 'filter-checkbox country-checkbox',
              checked: checkboxStates[country] || false
            });
            const count = initialCountryCounts[country] || 0;
            const label = $('<label>', { 'for': 'country_' +
                country, text: `${cName} (${country}; ${count})` });

            $('#country_checkboxes').append(checkbox).append(label).append('<br>');
        });


        {#if (isInitialLoad == true) {#}
        {#updateCheckboxCounts(results)#}
        {# }#}

        $('.filter-checkbox').change(function() {
            {#console.log('checkbox changed')#}
            // store state
            checkboxStates[this.value] = this.checked;
            console.log('checkboxStates', checkboxStates)

            // Get all checked checkboxes
            let checkedTypes = getCheckedTypes();
            let checkedCountries = getCheckedCountries();

            // Log the current selected types and countries for debugging
            {#console.log('Selected Types:', checkedTypes);#}
            {#console.log('Selected Countries:', checkedCountries);#}

            let filteredResults = filterResults(checkedTypes, checkedCountries);

            // Log the filtered results for debugging
            console.log('Filtered Results:', filteredResults);

            // Render the filtered results
            if (filteredResults.length > 0) {
                renderResults(filteredResults);
                renderDetail(filteredResults[0]); // Render details for the first result
                {#renderCheckboxes(filteredResults);#}
            } else {
                // Handle the case where there are no matching results
                $('#search_results').html('<p>No results match the selected filters.</p>');
                $('#detail').empty(); // You might also want to clear the detail view
            }
        });

        // send some fields to
        renderDetail(results[0]);

        $('.result').click(function() {
        const index = $(this).index(); // Get index of clicked card
          {#console.log('card index:', index)#}
          {#console.log('result', results[index])#}
        renderDetail(results[index]); // Update detail view with clicked result data
        $('.result').removeClass('selected');
        $(this).addClass('selected');
        // Future: Highlight marker on map corresponding to clicked result
        });

        {#console.log('geoms', geoms)#}
        {#renderPlaces(geoms)#}
    }

    function getAllTypes(results) {
        let typesSet = new Set();
        let typeCounts = {};

        results.forEach(result => {
            result.types.forEach(type => {
                typesSet.add(type);

                // Increment count for this type
                if (!typeCounts[type]) {
                    typeCounts[type] = 0;
                }
                typeCounts[type]++;
            });
        });

        // Set the global variable for initial type counts
        initialTypeCounts = typeCounts;

        return Array.from(typesSet).sort();
    }

    function getAllCountries(results) {
    let countriesSet = new Set();
    let countryCounts = {};

    results.forEach(result => {
        result.ccodes.forEach(country => {
            countriesSet.add(country);

            // Increment count for this country
            if (!countryCounts[country]) {
                countryCounts[country] = 0;
            }
            countryCounts[country]++;
        });
    });

    // Set the global variable for initial country counts
    initialCountryCounts = countryCounts;

    return Array.from(countriesSet).sort();
}

    function updateCheckboxCounts(results) {
        // Count the number of results for each type and country
        let typeCounts = {};
        let countryCounts = {};
        results.forEach(result => {
            result.types.forEach(type => {
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });
            result.ccodes.forEach(country => {
                countryCounts[country] = (countryCounts[country] || 0) + 1;
            });
        });

        // Update the checkbox labels with the counts
        $('.type-checkbox').each(function() {
            const type = this.value;
            {#console.log('type', this.value)#}
            $(`label[for='type_${type}']`).text(`${type} (${typeCounts[type] || 0})`);
        });
        $('.country-checkbox').each(function() {
            const country = this.value;
                const countryName = ccode_hash[country] ? ccode_hash[country]['gnlabel'] : country;
                $(`label[for='country_${country}']`).text(`${countryName} (${countryCounts[country] || 0})`);
            {#$(`label[for='country_${country}']`).text(`${country} (${countryCounts[country] || 0})`);#}
        });

    {#console.log('updateCheckboxCounts typeCounts', typeCounts)#}
    {#console.log('updateCheckboxCounts countryCounts', countryCounts)#}
    }

    function initiateSearch() {
        isInitialLoad = true;

        localStorage.removeItem('last_results')
        localStorage.removeItem('last_query')

        const query = $('#search-input').val(); // Get the query from the input
        localStorage.setItem('last_query', query); // Store the query in localStorage

        const options = gatherOptions(); //

        // AJAX GET request to SearchView() with the options (includes qstr)
        $.get("/search/index", options, function(data) {

            results = data['suggestions']; // replaces global variable
            localStorage.setItem('last_results', JSON.stringify(results));

            renderResults(results);

        });
    }

    function gatherOptions() {
    // gather and return option values from the UI
    fclasses = [];
    $('#search_filters input:checked').each(function() {
      fclasses.push($(this).val());
    });
    options = {
            "qstr":$('#d_input input').val(),
        "idx": "whg",
        "fclasses": fclasses.join(','),
        "start": $("#input_start").val(),
        "end": $("#input_end").val(),
        "bounds": $("#boundsobj").val()
    }
        return options;
    }

    function renderDetail(result) {
        let detailHtml = "";

        if (result.variants && result.variants.length > 0) {
            detailHtml += `<p>Variants: ${result.variants.join(', ')}</p>`;
        } else {
            detailHtml += `<p>No Variants Available</p>`; // Or you can just skip adding this line
        }

        if (result.ccodes && result.ccodes.length > 0) {
            detailHtml += `<p>Country Codes: ${result.ccodes.join(', ')}</p>`;
        } else {
            detailHtml += `<p>No Country Codes Available</p>`; // Or you can just skip adding this line
        }

        if (result.fclasses && result.fclasses.length > 0) {
            detailHtml += `<p>Feature Classes: ${result.fclasses.join(', ')}</p>`;
        } else {
            detailHtml += `<p>No Feature Classes Available</p>`; // Or you can just skip adding this line
        }

        if (result.types && result.types.length > 0) {
            detailHtml += `<p>Types: ${result.types.join(', ')}</p>`;
        } else {
            detailHtml += `<p>No Types Available</p>`; // Or you can just skip adding this line
        }

        $('#detail').html(detailHtml);
    }

    function renderPlaces(geoms) {
	    if(features){ features.clearLayers() }
	    if(typeof(traces)!=='undefined'){ traces.clearLayers() }

	    featcoll = {"type":"FeatureCollection","features":geoms}
	    // console.log('geodata prior to render',data)
	    var count_features = 0
	    idToFeature = {}
	    idToArea = {}
	    mappy.createPane('placePane');
	    mappy.getPane('placePane').style.zIndex = 200;

	    initialLayers = new L.featureGroup()
	    features = L.geoJSON(featcoll, {
	      pointToLayer: function (feature, latlng) {
	        count_features +=1;
	        // if feature has src key, it's from a database search
	        identifier = feature.src ? feature.properties.pid : feature.properties.whgid;
					// all geometry added from wikidata matches is MultiPoint...for some reason
	        if(feature.type.indexOf('Point') > -1){
	          marker = L.circleMarker(latlng, styles.marker_default)
	          // add to array for selection
	          idToFeature[identifier] = marker
	          return marker
	        }
	      },
	      onEachFeature: function(feature,layer) {
	        f=feature; l=layer;
	        // if feature has src key, it's from a database search; also, popup link differs
	        if(feature.src){
	          identifier = feature.properties.pid
	          popup_link = ' (<a href="/places/'+identifier+'/detail">place page</a>)'
	        } else {
	          identifier = feature.properties.whgid
	          popup_link = ' (<a href="/places/'+identifier+'/portal">place portal</a>)'
	        }
	        if(feature.type != 'Point'){
	          layer.setStyle(['LineString','MultiLineString'].indexOf(feature.type)>-1 ? styles.line_default:styles.pgon_default)
	          idToFeature[identifier] = layer
	        }
	        layer.bindPopup(feature.properties.title);

	        // find row in results and highlight it
	        layer.on('click',function(e){
	          scroll = 20
	          ele = $("#result_div")
	          // set all to white background
	          $(".search-row").css('background-color','#fff')

	          fid = search_scope=='idx'?this.feature.geometry.properties.whgid:this.feature.geometry.properties.pid

	          foo=$("tr.place-item").find('[data-id="'+fid+'"]').closest('.search-row')
	          foo.css('background-color','#f4f4d7')
	          foo[0].scrollIntoView()
	          ele.scrollTop(ele.scrollTop() - scroll);
	        })
	        //
	        initialLayers.addLayer(layer)
	      }
	    }).addTo(mappy); <!-- adds features L.geoJSON -->

	    bounds = features.getBounds()
	    if(geoms.length > 0 ){
	      mappy.fitBounds(bounds)
	      if(mappy.getZoom() > 5){ mappy.setZoom(5)}
	    }
	  }

  </script>
{% endblock %}
