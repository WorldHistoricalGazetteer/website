{% extends "admin/base_site.html" %}
{% load i18n %}
{% load metrics_extras %}

{% block title %}Metrics Dashboard{% endblock %}

{% block content %}
<div class="header-container">
    <h1>Metrics Dashboard</h1>
    <div class="button-container">
        <a href="{% url 'admin:download-all-data' %}" class="button">Download CSV</a>
    </div>
</div>

<style>
.header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
.admin-table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 30px;
}
.admin-table th, .admin-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}
.admin-table th {
    background-color: #f2f2f2;
    font-weight: bold;
}
.admin-table tr:nth-child(even) {background-color: #f9f9f9;}
.admin-table tr:hover {background-color: #e2e2e2;}
.bar-container {
    display: flex;
    height: 16px;
    width: 100%;
    background: #eee;
    border-radius: 4px;
    overflow: hidden;
}
.bar-segment {
    height: 100%;
    display: inline-block;
}
.bar-auth { background: #5bc0de; }
.bar-anon { background: #f0ad4e; }

/* New styles for metric panels */
.metric-panel-container {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
}
.metric-card {
    flex: 1;
    padding: 20px;
    border: 1px solid #e1e1e1;
    border-radius: 8px;
    background-color: #fcfcfc;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}
.metric-period-title {
    font-size: 1.2em;
    font-weight: bold;
    color: #555;
    margin-bottom: 15px;
}
.metric-value {
    font-size: 2.5em;
    font-weight: bold;
    color: #333;
}
.metric-label {
    font-size: 0.9em;
    color: #777;
    margin-bottom: 10px;
}
.metric-sparkline {
    height: 60px;
    width: 100%;
}
</style>

<h2>Site-wide Visitor Totals</h2>
<div class="metric-panel-container">
    {% for row in aggregate_data %}
    <div class="metric-card">
        <div class="metric-period-title">{{ row.period }}</div>

        <div class="metric">
            <div class="metric-label" title="Total number of distinct visitor sessions">Unique Visitors</div>
            <div class="metric-value">{{ row.unique_count }}</div>
            <canvas class="metric-sparkline" data-sparkline-data="{{ row.unique_sparkline_data }}" data-sparkline-color="#007bff"></canvas>
        </div>

        <div class="metric" style="margin-top: 20px;">
            <div class="metric-label" title="Number of distinct visitors with their first visit in the selected period">New Visitors</div>
            <div class="metric-value">{{ row.new_count }}</div>
            <canvas class="metric-sparkline" data-sparkline-data="{{ row.new_sparkline_data }}" data-sparkline-color="#28a745"></canvas>
        </div>
    </div>
    {% endfor %}
</div>

<h2>URL Performance</h2>
<table class="admin-table">
    <thead>
        <tr>
            <th>URL</th>
            {% for period in periods %}
            <th>{{ period|capfirst }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for row in url_data %}
        <tr>
            <td><a href="{{ row.url }}" target="_blank">{{ row.url }}</a></td>
            {% for period in periods %}
            {% with auth_pct_key=period|add:"_auth_pct" anon_pct_key=period|add:"_anon_pct" label_key=period|add:"_label" %}
            <td>
                <div class="bar-container">
                    <div class="bar-segment bar-auth" style="width: {{ row|get_item:auth_pct_key }}%"></div>
                    <div class="bar-segment bar-anon" style="width: {{ row|get_item:anon_pct_key }}%"></div>
                </div>
                <small>{{ row|get_item:label_key }}</small>
            </td>
            {% endwith %}
            {% endfor %}
        </tr>
        {% empty %}
        <tr>
            <td colspan="{{ periods|length|add:'1' }}">No data available.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const canvases = document.querySelectorAll('canvas[data-sparkline-data]');

        canvases.forEach(canvas => {
            const data = JSON.parse(canvas.getAttribute('data-sparkline-data'));
            const color = canvas.getAttribute('data-sparkline-color');

            if (!data || data.length < 2) {
                return;
            }

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 5;

            // Normalize data to fit canvas height
            const maxVal = Math.max(...data);
            const normalizedData = (maxVal > 0)
                ? data.map(val => height - padding - (val / maxVal) * (height - 2 * padding))
                : new Array(data.length).fill(height - padding);

            ctx.clearRect(0, 0, width, height);

            ctx.beginPath();
            ctx.moveTo(0, normalizedData[0]);

            const step = width / (normalizedData.length - 1);
            for (let i = 1; i < normalizedData.length; i++) {
                ctx.lineTo(i * step, normalizedData[i]);
            }

            ctx.lineJoin = 'round';
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.stroke();
        });
    });
</script>
{% endblock %}