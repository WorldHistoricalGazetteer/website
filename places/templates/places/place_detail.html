<!-- places/place_detail.html -->
{% extends "main/base.html" %}
{% load dataset_extras %}

{% load geojson_tags %}
{% load leaflet_tags %}
{% load static %}
{% block title %}<title>WHG::Place</title>{% endblock %}
{% block extra_head %}
  {% leaflet_js %}
  {% leaflet_css %}

  <script src="{% static 'js/tags/bootstrap-tagsinput.js' %}"></script>
  <script src="{% static 'js/tags/bloodhound.js' %}"></script>
  <script src="{% static 'js/clipboard.min.js' %}"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  
  <link rel="stylesheet" href="{% static 'js/tags/bootstrap-tagsinput.css' %}"/>
  <link rel="stylesheet" href="{% static 'js/tags/bootstrap-tagsinput-typeahead.css' %}"/>
  <link rel="stylesheet" href="{% static 'css/spin.css' %}"/>
  
  <link href="{% static 'webpack/places.bundle.css' %}" rel="stylesheet" /> 
{% endblock %}


{% block content %}
<div class="container">
  <span class="me-1 text-muted smaller">
  <a href="javascript:window.history.go(-1);">return to search results</a></span>

  <h4 class="mt-3">
    <span class="text-danger">{{ object.title }}</span> <small class="text-secondary ms-2">({{ dataset.title}})</small>
  </h4>
  <div class="d-flex">
    <div class="col-sm-7 form-box mt-2 me-2">
      <div class="bg-white p-2">
        <table class="w-100">
          <colgroup><col style="width:150px;"></col><col></col></colgroup>
          <tr><td>Record title:</td><td>{{ object.title }}</td></tr>
          <tr><td>WHG identifier:</td><td>{{ object.id }} (<a href="/api/db/?id={{object.id}}" target="_blank">Linked Places record</a>)</td></tr>
          <tr><td>Source identifier:</td>
            <td>{{ object.src_id }} 
              {% if not 'whg' in dataset.uri_base %} 
                <a href="{{dataset.uri_base}}{{object.src_id}}" target="_blank">source record <i class="fas fa-external-link-alt linky"></i></a>
              {% endif %}</td>
          </tr>
          <tr><td>Variants:</td><td>{% for n in object.names.all %}
          <i>{{n.jsonb.toponym }};</i> {% endfor %}</td></tr>
          
          {% if object.description %}
          <tr><td><b>Description</b></td><td>{{ object.description }}</td></tr>{% endif %}
          <tr>
            <td>Earliest/Latest:</td>
            {% if object.minmax %}
              {{ minmax|json_script:object.id }}
              {{ timespans|json_script:object.id }}
              <span id="ptimespans" style="opacity:0;position:absolute;z-index:-1">{{ object.timespans }}</span>
            <td>{{object.minmax.0}} / {{object.minmax.1}}</td>
          </tr>
          {% else %}<td><i>no associated temporal info</i></td>{% endif %}
          
          <tr><td>Type(s):</td><td>{% for t in object.types.all %}
          {{t.jsonb.sourceLabel }}{%if t.label %} ({{ t.label }}) {% endif %}; {% endfor %}</td></tr>
          
          <tr><td>Linked records in WHG:</td>
            <td>{% if object.links|length > 0 %}{% for l in object.links.all %}{{l}}; {%endfor%}{%else%}<i>none yet{%endif%}
            </td></tr>
            
          {% if object.geoms %}
          <tr>
            <td><b>Locations ({{object.geoms.all|length}}):</b>
              <span id="pgeom" style="opacity:0;position:absolute;z-index:-1">
              {% for g in object.geoms.all %}
                {{ g.jsonb.coordinates }}
                {{ g.jsonb|json_script:object.id }}
              {%endfor%}
              </span>
            </td>
            <td>
            <a id="a_clipgeom" class="clippy" data-clipboard-target="#pgeom" rel="tooltip" title="copy to clipboard">copy coordinates to clipboard <i class="fas fa-clipboard linky"></i></a></td>
          </tr>
          {% endif %}
          
          {% if object.related %}
            <tr><td>Related:</td>
              <td>
                {% for r in object.related.all %}
                  <i>part of</i>: {{ r.jsonb.label }} {% if r.jsonb.when %} {{r.jsonb.when.timespans }} {% endif %}
                {%endfor%}
              </td>
            </tr>
          {% endif %}
          
        </table>
        <div id="place_temporal" class="col-content small">
          <p class="mb-0 allcap-heading">TEMPORAL ATTESTATIONS</p>
          <!--<div id="histogram_modal" class="svg-container"></div>-->
          <div id="histogram" class=""></div>
        </div>
      </div>
      <hr/>
      <div id="coll_dslist" class="">
        <p class="larger strong mb-0">Dataset details</p>
        <div id="ds_cards">
          <table class="w-75">
          <colgroup><col style="width:150px;"></col><col></col></colgroup>
          <tr><td>Title:</td><td></td> <td><a href="{% url 'datasets:ds_meta' dataset.id %}">{{ dataset.title }}</a></td></tr>
          {% if dataset.minmax %}
          <tr><td>Earliest/Latest:</td><td> </td><td>{{dataset.minmax.0}} / {{dataset.minmax.1}} </td></tr>{% endif %}
          <tr><td>Creator(s):</td><td> </td><td>{{dataset.creator}}</td></tr>
          <tr><td>Last modified:</td><td> </td><td>{{dataset.last_modified_text}}</td></tr>
          </table>
        </div> <!-- #ds_cards -->        
      </div> <!-- #coll_dslist -->
    </div>
    <!--<div class="col-sm-5 mt-2">-->
    <div id="mapdiv" class="col-sm-5 mt-2" style="max-height:400px"></div>
  </div> <!-- d-flex -->
</div> <!-- container -->

<!-- Set up MapLibre map using Maptiler SDK -->
<script type="text/javascript">
    let mapParameters = {
        container: 'mapdiv',
        center: [10.2385, 29.8626],
        zoom: 0.1, // starting zoom
        minZoom: 0.1,
        maxZoom: 10,
        mapTilerKey: '{{ maptilerkey }}',
        controls: {
            layer: true,
            navigation: false,
            fullscreen: false,
            attribution: {
                open: false,
            },
            temporal: {
                fromValue: 1550,
                toValue: 1720,
                minValue: -2000,
                maxValue: 2100,
                open: false,
                includeUndated: true, // null | false | true - 'false/true' determine state of select box input; 'null' excludes the button altogether
                epochs: null,
                automate: null,
            }
        },
        styleFilter: [ 'OUTDOOR.DEFAULT' ], // Leave empty for full list of options, or include a single style to prevent selector inclusion
    }
</script>

<script type="module">
    import "{% static 'webpack/places.bundle.js' %}";
</script>
{% endblock %}
